"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[16],{19:function(t,e,n){n.d(e,{u7:function(){return du},Jj:function(){return cc},IX:function(){return Qa},my:function(){return Oa},xU:function(){return Bc},Lz:function(){return ac},WA:function(){return S},F8:function(){return hc},$q:function(){return Kc},W:function(){return $c},EK:function(){return U},PU:function(){return gu},l7:function(){return Sa},Ky:function(){return ct},Xb:function(){return W},Cf:function(){return xa},K9:function(){return T},Me:function(){return Y},yq:function(){return y},Wi:function(){return Aa},ET:function(){return Au},Ab:function(){return Pu},vr:function(){return Ou},Fc:function(){return tc},hJ:function(){return qa},B$:function(){return Ua},at:function(){return Fa},oe:function(){return _u},AK:function(){return Mu},TF:function(){return rc},JU:function(){return Ba},ST:function(){return Ja},fH:function(){return Xa},Ix:function(){return nc},Wu:function(){return au},Lx:function(){return ou},qY:function(){return Ha},GL:function(){return Cu},QT:function(){return yu},kl:function(){return vu},Xk:function(){return Iu},PL:function(){return Tu},UQ:function(){return Eu},zN:function(){return bu},nP:function(){return Vu},b9:function(){return tu},vh:function(){return eu},Pb:function(){return sc},L$:function(){return ic},cf:function(){return Nu},sc:function(){return Du},Xo:function(){return Xc},IO:function(){return Wc},iE:function(){return $a},Eo:function(){return Ka},i3:function(){return Lu},Bt:function(){return Fu},pl:function(){return Su},Ub:function(){return m},qK:function(){return Gc},TQ:function(){return su},e0:function(){return ru},r7:function(){return ku},Mx:function(){return ec},ar:function(){return Yc}});var r=n(2238),s=n(8463),i=n(3333),o=n(4444),a=n(3510),c=n(4155);const u="@firebase/firestore";class h{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}h.UNAUTHENTICATED=new h(null),h.GOOGLE_CREDENTIALS=new h("google-credentials-uid"),h.FIRST_PARTY=new h("first-party-uid"),h.MOCK_USER=new h("mock-user");let l="9.6.1";const d=new i.Yd("@firebase/firestore");function f(){return d.logLevel}function m(t){d.setLogLevel(t)}function g(t,...e){if(d.logLevel<=i.in.DEBUG){const n=e.map(w);d.debug(`Firestore (${l}): ${t}`,...n)}}function p(t,...e){if(d.logLevel<=i.in.ERROR){const n=e.map(w);d.error(`Firestore (${l}): ${t}`,...n)}}function y(t,...e){if(d.logLevel<=i.in.WARN){const n=e.map(w);d.warn(`Firestore (${l}): ${t}`,...n)}}function w(t){if("string"==typeof t)return t;try{return e=t,JSON.stringify(e)}catch(e){return t}var e}function v(t="Unexpected state"){const e=`FIRESTORE (${l}) INTERNAL ASSERTION FAILED: `+t;throw p(e),new Error(e)}function I(t,e){t||v()}function T(t,e){t||v()}function E(t,e){return t}const b={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class S extends Error{constructor(t,e){super(e),this.code=t,this.message=e,this.name="FirebaseError",this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class k{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class _{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class A{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(h.UNAUTHENTICATED)))}shutdown(){}}class N{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class D{constructor(t){this.t=t,this.currentUser=h.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const r=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let s=new k;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new k,t.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const e=s;t.enqueueRetryable((async()=>{await e.promise,await r(this.currentUser)}))},o=t=>{g("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((t=>o(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?o(t):(g("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new k)}}),0),i()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(g("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(I("string"==typeof e.accessToken),new _(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return I(null===t||"string"==typeof t),new h(t)}}class C{constructor(t,e,n){this.type="FirstParty",this.user=h.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",e);const r=t.auth.getAuthHeaderValueForFirstParty([]);r&&this.headers.set("Authorization",r),n&&this.headers.set("X-Goog-Iam-Authorization-Token",n)}}class x{constructor(t,e,n){this.h=t,this.l=e,this.m=n}getToken(){return Promise.resolve(new C(this.h,this.l,this.m))}start(t,e){t.enqueueRetryable((()=>e(h.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class R{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class L{constructor(t){this.g=t,this.forceRefresh=!1,this.appCheck=null}start(t,e){this.o=n=>{t.enqueueRetryable((()=>(t=>(null!=t.error&&g("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`),e(t.token)))(n)))};const n=t=>{g("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.appCheck.addTokenListener(this.o)};this.g.onInit((t=>n(t))),setTimeout((()=>{if(!this.appCheck){const t=this.g.getImmediate({optional:!0});t?n(t):g("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((t=>t?(I("string"==typeof t.token),new R(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class M{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.p(t),this.T=t=>e.writeSequenceNumber(t))}p(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.T&&this.T(t),t}}function F(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let r=0;r<t;r++)n[r]=Math.floor(256*Math.random());return n}M.I=-1;class O{static A(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length;let n="";for(;n.length<20;){const r=F(40);for(let s=0;s<r.length;++s)n.length<20&&r[s]<e&&(n+=t.charAt(r[s]%t.length))}return n}}function P(t,e){return t<e?-1:t>e?1:0}function V(t,e,n){return t.length===e.length&&t.every(((t,r)=>n(t,e[r])))}function q(t){return t+"\0"}class U{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new S(b.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new S(b.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new S(b.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new S(b.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return U.fromMillis(Date.now())}static fromDate(t){return U.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new U(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?P(this.nanoseconds,t.nanoseconds):P(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class B{constructor(t){this.timestamp=t}static fromTimestamp(t){return new B(t)}static min(){return new B(new U(0,0))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}function K(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function $(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function j(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class G{constructor(t,e,n){void 0===e?e=0:e>t.length&&v(),void 0===n?n=t.length-e:n>t.length-e&&v(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===G.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof G?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let r=0;r<n;r++){const n=t.get(r),s=e.get(r);if(n<s)return-1;if(n>s)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class z extends G{construct(t,e,n){return new z(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new S(b.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter((t=>t.length>0)))}return new z(e)}static emptyPath(){return new z([])}}const Q=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class W extends G{construct(t,e,n){return new W(t,e,n)}static isValidIdentifier(t){return Q.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),W.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new W(["__name__"])}static fromServerFormat(t){const e=[];let n="",r=0;const s=()=>{if(0===n.length)throw new S(b.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;r<t.length;){const e=t[r];if("\\"===e){if(r+1===t.length)throw new S(b.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[r+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new S(b.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,r+=2}else"`"===e?(i=!i,r++):"."!==e||i?(n+=e,r++):(s(),r++)}if(s(),i)throw new S(b.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new W(e)}static emptyPath(){return new W([])}}class H{constructor(t){this.fields=t,t.sort(W.comparator)}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return V(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}function Y(){return"undefined"!=typeof atob}class J{constructor(t){this.binaryString=t}static fromBase64String(t){const e=atob(t);return new J(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new J(e)}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return P(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}J.EMPTY_BYTE_STRING=new J("");const X=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Z(t){if(I(!!t),"string"==typeof t){let e=0;const n=X.exec(t);if(I(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}return{seconds:tt(t.seconds),nanos:tt(t.nanos)}}function tt(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function et(t){return"string"==typeof t?J.fromBase64String(t):J.fromUint8Array(t)}function nt(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function rt(t){const e=t.mapValue.fields.__previous_value__;return nt(e)?rt(e):e}function st(t){const e=Z(t.mapValue.fields.__local_write_time__.timestampValue);return new U(e.seconds,e.nanos)}function it(t){return null==t}function ot(t){return 0===t&&1/t==-1/0}function at(t){return"number"==typeof t&&Number.isInteger(t)&&!ot(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}class ct{constructor(t){this.path=t}static fromPath(t){return new ct(z.fromString(t))}static fromName(t){return new ct(z.fromString(t).popFirst(5))}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}isEqual(t){return null!==t&&0===z.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return z.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new ct(new z(t.slice()))}}function ut(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?nt(t)?4:10:v()}function ht(t,e){const n=ut(t);if(n!==ut(e))return!1;switch(n){case 0:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return st(t).isEqual(st(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=Z(t.timestampValue),r=Z(e.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return et(t.bytesValue).isEqual(et(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return tt(t.geoPointValue.latitude)===tt(e.geoPointValue.latitude)&&tt(t.geoPointValue.longitude)===tt(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return tt(t.integerValue)===tt(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=tt(t.doubleValue),r=tt(e.doubleValue);return n===r?ot(n)===ot(r):isNaN(n)&&isNaN(r)}return!1}(t,e);case 9:return V(t.arrayValue.values||[],e.arrayValue.values||[],ht);case 10:return function(t,e){const n=t.mapValue.fields||{},r=e.mapValue.fields||{};if(K(n)!==K(r))return!1;for(const s in n)if(n.hasOwnProperty(s)&&(void 0===r[s]||!ht(n[s],r[s])))return!1;return!0}(t,e);default:return v()}}function lt(t,e){return void 0!==(t.values||[]).find((t=>ht(t,e)))}function dt(t,e){const n=ut(t),r=ut(e);if(n!==r)return P(n,r);switch(n){case 0:return 0;case 1:return P(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=tt(t.integerValue||t.doubleValue),r=tt(e.integerValue||e.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(t,e);case 3:return ft(t.timestampValue,e.timestampValue);case 4:return ft(st(t),st(e));case 5:return P(t.stringValue,e.stringValue);case 6:return function(t,e){const n=et(t),r=et(e);return n.compareTo(r)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),r=e.split("/");for(let s=0;s<n.length&&s<r.length;s++){const t=P(n[s],r[s]);if(0!==t)return t}return P(n.length,r.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=P(tt(t.latitude),tt(e.latitude));return 0!==n?n:P(tt(t.longitude),tt(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],r=e.values||[];for(let s=0;s<n.length&&s<r.length;++s){const t=dt(n[s],r[s]);if(t)return t}return P(n.length,r.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){const n=t.fields||{},r=Object.keys(n),s=e.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let o=0;o<r.length&&o<i.length;++o){const t=P(r[o],i[o]);if(0!==t)return t;const e=dt(n[r[o]],s[i[o]]);if(0!==e)return e}return P(r.length,i.length)}(t.mapValue,e.mapValue);default:throw v()}}function ft(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return P(t,e);const n=Z(t),r=Z(e),s=P(n.seconds,r.seconds);return 0!==s?s:P(n.nanos,r.nanos)}function mt(t){return gt(t)}function gt(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=Z(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?et(t.bytesValue).toBase64():"referenceValue"in t?(n=t.referenceValue,ct.fromName(n).toString()):"geoPointValue"in t?`geo(${(e=t.geoPointValue).latitude},${e.longitude})`:"arrayValue"in t?function(t){let e="[",n=!0;for(const r of t.values||[])n?n=!1:e+=",",e+=gt(r);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",r=!0;for(const s of e)r?r=!1:n+=",",n+=`${s}:${gt(t.fields[s])}`;return n+"}"}(t.mapValue):v();var e,n}function pt(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function yt(t){return!!t&&"integerValue"in t}function wt(t){return!!t&&"arrayValue"in t}function vt(t){return!!t&&"nullValue"in t}function It(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function Tt(t){return!!t&&"mapValue"in t}function Et(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return $(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=Et(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=Et(t.arrayValue.values[n]);return e}return Object.assign({},t)}class bt{constructor(t){this.value=t}static empty(){return new bt({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!Tt(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=Et(e)}setAll(t){let e=W.emptyPath(),n={},r=[];t.forEach(((t,s)=>{if(!e.isImmediateParentOf(s)){const t=this.getFieldsMap(e);this.applyChanges(t,n,r),n={},r=[],e=s.popLast()}t?n[s.lastSegment()]=Et(t):r.push(s.lastSegment())}));const s=this.getFieldsMap(e);this.applyChanges(s,n,r)}delete(t){const e=this.field(t.popLast());Tt(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return ht(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let r=e.mapValue.fields[t.get(n)];Tt(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=r),e=r}return e.mapValue.fields}applyChanges(t,e,n){$(e,((e,n)=>t[e]=n));for(const r of n)delete t[r]}clone(){return new bt(Et(this.value))}}function St(t){const e=[];return $(t.fields,((t,n)=>{const r=new W([t]);if(Tt(n)){const t=St(n.mapValue).fields;if(0===t.length)e.push(r);else for(const n of t)e.push(r.child(n))}else e.push(r)})),new H(e)}class kt{constructor(t,e,n,r,s){this.key=t,this.documentType=e,this.version=n,this.data=r,this.documentState=s}static newInvalidDocument(t){return new kt(t,0,B.min(),bt.empty(),0)}static newFoundDocument(t,e,n){return new kt(t,1,e,n,0)}static newNoDocument(t,e){return new kt(t,2,e,bt.empty(),0)}static newUnknownDocument(t,e){return new kt(t,3,e,bt.empty(),2)}convertToFoundDocument(t,e){return this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=bt.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=bt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof kt&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}clone(){return new kt(this.key,this.documentType,this.version,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class _t{constructor(t,e=null,n=[],r=[],s=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.R=null}}function At(t,e=null,n=[],r=[],s=null,i=null,o=null){return new _t(t,e,n,r,s,i,o)}function Nt(t){const e=E(t);if(null===e.R){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>function(t){return t.field.canonicalString()+t.op.toString()+mt(t.value)}(t))).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),it(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=Bt(e.startAt)),e.endAt&&(t+="|ub:",t+=Bt(e.endAt)),e.R=t}return e.R}function Dt(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let s=0;s<t.orderBy.length;s++)if(!$t(t.orderBy[s],e.orderBy[s]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let s=0;s<t.filters.length;s++)if(n=t.filters[s],r=e.filters[s],n.op!==r.op||!n.field.isEqual(r.field)||!ht(n.value,r.value))return!1;var n,r;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!Gt(t.startAt,e.startAt)&&Gt(t.endAt,e.endAt)}function Ct(t){return ct.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}class xt extends class{}{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.P(t,e,n):new Rt(t,e,n):"array-contains"===e?new Ot(t,n):"in"===e?new Pt(t,n):"not-in"===e?new Vt(t,n):"array-contains-any"===e?new qt(t,n):new xt(t,e,n)}static P(t,e,n){return"in"===e?new Lt(t,n):new Mt(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.v(dt(e,this.value)):null!==e&&ut(this.value)===ut(e)&&this.v(dt(e,this.value))}v(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return v()}}V(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}class Rt extends xt{constructor(t,e,n){super(t,e,n),this.key=ct.fromName(n.referenceValue)}matches(t){const e=ct.comparator(t.key,this.key);return this.v(e)}}class Lt extends xt{constructor(t,e){super(t,"in",e),this.keys=Ft("in",e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class Mt extends xt{constructor(t,e){super(t,"not-in",e),this.keys=Ft("not-in",e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function Ft(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>ct.fromName(t.referenceValue)))}class Ot extends xt{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return wt(e)&&lt(e.arrayValue,this.value)}}class Pt extends xt{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&lt(this.value.arrayValue,e)}}class Vt extends xt{constructor(t,e){super(t,"not-in",e)}matches(t){if(lt(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!lt(this.value.arrayValue,e)}}class qt extends xt{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!wt(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>lt(this.value.arrayValue,t)))}}class Ut{constructor(t,e){this.position=t,this.before=e}}function Bt(t){return`${t.before?"b":"a"}:${t.position.map((t=>mt(t))).join(",")}`}class Kt{constructor(t,e="asc"){this.field=t,this.dir=e}}function $t(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}function jt(t,e,n){let r=0;for(let s=0;s<t.position.length;s++){const i=e[s],o=t.position[s];if(r=i.field.isKeyField()?ct.comparator(ct.fromName(o.referenceValue),n.key):dt(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return t.before?r<=0:r<0}function Gt(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.before!==e.before||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!ht(t.position[n],e.position[n]))return!1;return!0}class zt{constructor(t,e=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.S=null,this.D=null,this.startAt,this.endAt}}function Qt(t,e,n,r,s,i,o,a){return new zt(t,e,n,r,s,i,o,a)}function Wt(t){return new zt(t)}function Ht(t){return!it(t.limit)&&"F"===t.limitType}function Yt(t){return!it(t.limit)&&"L"===t.limitType}function Jt(t){return t.explicitOrderBy.length>0?t.explicitOrderBy[0].field:null}function Xt(t){for(const e of t.filters)if(e.V())return e.field;return null}function Zt(t){return null!==t.collectionGroup}function te(t){const e=E(t);if(null===e.S){e.S=[];const t=Xt(e),n=Jt(e);if(null!==t&&null===n)t.isKeyField()||e.S.push(new Kt(t)),e.S.push(new Kt(W.keyField(),"asc"));else{let t=!1;for(const n of e.explicitOrderBy)e.S.push(n),n.field.isKeyField()&&(t=!0);if(!t){const t=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";e.S.push(new Kt(W.keyField(),t))}}}return e.S}function ee(t){const e=E(t);if(!e.D)if("F"===e.limitType)e.D=At(e.path,e.collectionGroup,te(e),e.filters,e.limit,e.startAt,e.endAt);else{const t=[];for(const s of te(e)){const e="desc"===s.dir?"asc":"desc";t.push(new Kt(s.field,e))}const n=e.endAt?new Ut(e.endAt.position,!e.endAt.before):null,r=e.startAt?new Ut(e.startAt.position,!e.startAt.before):null;e.D=At(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}return e.D}function ne(t,e,n){return new zt(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function re(t,e){return Dt(ee(t),ee(e))&&t.limitType===e.limitType}function se(t){return`${Nt(ee(t))}|lt:${t.limitType}`}function ie(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>{return`${(e=t).field.canonicalString()} ${e.op} ${mt(e.value)}`;var e})).join(", ")}]`),it(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: "+Bt(t.startAt)),t.endAt&&(e+=", endAt: "+Bt(t.endAt)),`Target(${e})`}(ee(t))}; limitType=${t.limitType})`}function oe(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):ct.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of t.explicitOrderBy)if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!jt(t.startAt,te(t),e))&&(!t.endAt||!jt(t.endAt,te(t),e))}(t,e)}function ae(t){return(e,n)=>{let r=!1;for(const s of te(t)){const t=ce(s,e,n);if(0!==t)return t;r=r||s.field.isKeyField()}return 0}}function ce(t,e,n){const r=t.field.isKeyField()?ct.comparator(e.key,n.key):function(t,e,n){const r=e.data.field(t),s=n.data.field(t);return null!==r&&null!==s?dt(r,s):v()}(t.field,e,n);switch(t.dir){case"asc":return r;case"desc":return-1*r;default:return v()}}function ue(t,e){if(t.C){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ot(e)?"-0":e}}function he(t){return{integerValue:""+t}}function le(t,e){return at(e)?he(e):ue(t,e)}class de{constructor(){this._=void 0}}function fe(t,e,n){return t instanceof pe?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof ye?we(t,e):t instanceof ve?Ie(t,e):function(t,e){const n=ge(t,e),r=Ee(n)+Ee(t.N);return yt(n)&&yt(t.N)?he(r):ue(t.k,r)}(t,e)}function me(t,e,n){return t instanceof ye?we(t,e):t instanceof ve?Ie(t,e):n}function ge(t,e){return t instanceof Te?yt(n=e)||function(t){return!!t&&"doubleValue"in t}(n)?e:{integerValue:0}:null;var n}class pe extends de{}class ye extends de{constructor(t){super(),this.elements=t}}function we(t,e){const n=be(e);for(const r of t.elements)n.some((t=>ht(t,r)))||n.push(r);return{arrayValue:{values:n}}}class ve extends de{constructor(t){super(),this.elements=t}}function Ie(t,e){let n=be(e);for(const r of t.elements)n=n.filter((t=>!ht(t,r)));return{arrayValue:{values:n}}}class Te extends de{constructor(t,e){super(),this.k=t,this.N=e}}function Ee(t){return tt(t.integerValue||t.doubleValue)}function be(t){return wt(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class Se{constructor(t,e){this.field=t,this.transform=e}}class ke{constructor(t,e){this.version=t,this.transformResults=e}}class _e{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new _e}static exists(t){return new _e(void 0,t)}static updateTime(t){return new _e(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Ae(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class Ne{}function De(t,e,n){t instanceof Me?function(t,e,n){const r=t.value.clone(),s=Pe(t.fieldTransforms,e,n.transformResults);r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):t instanceof Fe?function(t,e,n){if(!Ae(t.precondition,e))return void e.convertToUnknownDocument(n.version);const r=Pe(t.fieldTransforms,e,n.transformResults),s=e.data;s.setAll(Oe(t)),s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function Ce(t,e,n){t instanceof Me?function(t,e,n){if(!Ae(t.precondition,e))return;const r=t.value.clone(),s=Ve(t.fieldTransforms,n,e);r.setAll(s),e.convertToFoundDocument(Le(e),r).setHasLocalMutations()}(t,e,n):t instanceof Fe?function(t,e,n){if(!Ae(t.precondition,e))return;const r=Ve(t.fieldTransforms,n,e),s=e.data;s.setAll(Oe(t)),s.setAll(r),e.convertToFoundDocument(Le(e),s).setHasLocalMutations()}(t,e,n):function(t,e){Ae(t.precondition,e)&&e.convertToNoDocument(B.min())}(t,e)}function xe(t,e){let n=null;for(const r of t.fieldTransforms){const t=e.data.field(r.field),s=ge(r.transform,t||null);null!=s&&(null==n&&(n=bt.empty()),n.set(r.field,s))}return n||null}function Re(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&V(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof ye&&e instanceof ye||t instanceof ve&&e instanceof ve?V(t.elements,e.elements,ht):t instanceof Te&&e instanceof Te?ht(t.N,e.N):t instanceof pe&&e instanceof pe}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}function Le(t){return t.isFoundDocument()?t.version:B.min()}class Me extends Ne{constructor(t,e,n,r=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=r,this.type=0}}class Fe extends Ne{constructor(t,e,n,r,s=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}}function Oe(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=t.data.field(n);e.set(n,r)}})),e}function Pe(t,e,n){const r=new Map;I(t.length===n.length);for(let s=0;s<n.length;s++){const i=t[s],o=i.transform,a=e.data.field(i.field);r.set(i.field,me(o,a,n[s]))}return r}function Ve(t,e,n){const r=new Map;for(const s of t){const t=s.transform,i=n.data.field(s.field);r.set(s.field,fe(t,i,e))}return r}class qe extends Ne{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}}class Ue extends Ne{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}}class Be{constructor(t){this.count=t}}var Ke,$e;function je(t){switch(t){default:return v();case b.CANCELLED:case b.UNKNOWN:case b.DEADLINE_EXCEEDED:case b.RESOURCE_EXHAUSTED:case b.INTERNAL:case b.UNAVAILABLE:case b.UNAUTHENTICATED:return!1;case b.INVALID_ARGUMENT:case b.NOT_FOUND:case b.ALREADY_EXISTS:case b.PERMISSION_DENIED:case b.FAILED_PRECONDITION:case b.ABORTED:case b.OUT_OF_RANGE:case b.UNIMPLEMENTED:case b.DATA_LOSS:return!0}}function Ge(t){if(void 0===t)return p("GRPC error has no .code"),b.UNKNOWN;switch(t){case Ke.OK:return b.OK;case Ke.CANCELLED:return b.CANCELLED;case Ke.UNKNOWN:return b.UNKNOWN;case Ke.DEADLINE_EXCEEDED:return b.DEADLINE_EXCEEDED;case Ke.RESOURCE_EXHAUSTED:return b.RESOURCE_EXHAUSTED;case Ke.INTERNAL:return b.INTERNAL;case Ke.UNAVAILABLE:return b.UNAVAILABLE;case Ke.UNAUTHENTICATED:return b.UNAUTHENTICATED;case Ke.INVALID_ARGUMENT:return b.INVALID_ARGUMENT;case Ke.NOT_FOUND:return b.NOT_FOUND;case Ke.ALREADY_EXISTS:return b.ALREADY_EXISTS;case Ke.PERMISSION_DENIED:return b.PERMISSION_DENIED;case Ke.FAILED_PRECONDITION:return b.FAILED_PRECONDITION;case Ke.ABORTED:return b.ABORTED;case Ke.OUT_OF_RANGE:return b.OUT_OF_RANGE;case Ke.UNIMPLEMENTED:return b.UNIMPLEMENTED;case Ke.DATA_LOSS:return b.DATA_LOSS;default:return v()}}($e=Ke||(Ke={}))[$e.OK=0]="OK",$e[$e.CANCELLED=1]="CANCELLED",$e[$e.UNKNOWN=2]="UNKNOWN",$e[$e.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",$e[$e.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",$e[$e.NOT_FOUND=5]="NOT_FOUND",$e[$e.ALREADY_EXISTS=6]="ALREADY_EXISTS",$e[$e.PERMISSION_DENIED=7]="PERMISSION_DENIED",$e[$e.UNAUTHENTICATED=16]="UNAUTHENTICATED",$e[$e.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",$e[$e.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",$e[$e.ABORTED=10]="ABORTED",$e[$e.OUT_OF_RANGE=11]="OUT_OF_RANGE",$e[$e.UNIMPLEMENTED=12]="UNIMPLEMENTED",$e[$e.INTERNAL=13]="INTERNAL",$e[$e.UNAVAILABLE=14]="UNAVAILABLE",$e[$e.DATA_LOSS=15]="DATA_LOSS";class ze{constructor(t,e){this.comparator=t,this.root=e||We.EMPTY}insert(t,e){return new ze(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,We.BLACK,null,null))}remove(t){return new ze(this.comparator,this.root.remove(t,this.comparator).copy(null,null,We.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(t,n.key);if(0===r)return e+n.left.size;r<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new Qe(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new Qe(this.root,t,this.comparator,!1)}getReverseIterator(){return new Qe(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new Qe(this.root,t,this.comparator,!0)}}class Qe{constructor(t,e,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?n(t.key,e):1,r&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(0===s){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class We{constructor(t,e,n,r,s){this.key=t,this.value=e,this.color=null!=n?n:We.RED,this.left=null!=r?r:We.EMPTY,this.right=null!=s?s:We.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,r,s){return new We(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let r=this;const s=n(t,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===s?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return We.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(t,r.key)){if(r.right.isEmpty())return We.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,We.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,We.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw v();if(this.right.isRed())throw v();const t=this.left.check();if(t!==this.right.check())throw v();return t+(this.isRed()?0:1)}}We.EMPTY=null,We.RED=!0,We.BLACK=!1,We.EMPTY=new class{constructor(){this.size=0}get key(){throw v()}get value(){throw v()}get color(){throw v()}get left(){throw v()}get right(){throw v()}copy(t,e,n,r,s){return this}insert(t,e,n){return new We(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class He{constructor(t){this.comparator=t,this.data=new ze(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,t[1])>=0)return;e(r.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Ye(this.data.getIterator())}getIteratorFrom(t){return new Ye(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof He))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(0!==this.comparator(t,r))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new He(this.comparator);return e.data=t,e}}class Ye{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}const Je=new ze(ct.comparator);function Xe(){return Je}const Ze=new ze(ct.comparator);function tn(){return Ze}const en=new ze(ct.comparator);function nn(){return en}const rn=new He(ct.comparator);function sn(...t){let e=rn;for(const n of t)e=e.add(n);return e}const on=new He(P);function an(){return on}class cn{constructor(t,e,n,r,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e){const n=new Map;return n.set(t,un.createSynthesizedTargetChangeForCurrentChange(t,e)),new cn(B.min(),n,an(),Xe(),sn())}}class un{constructor(t,e,n,r,s){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e){return new un(J.EMPTY_BYTE_STRING,e,sn(),sn(),sn())}}class hn{constructor(t,e,n,r){this.$=t,this.removedTargetIds=e,this.key=n,this.F=r}}class ln{constructor(t,e){this.targetId=t,this.O=e}}class dn{constructor(t,e,n=J.EMPTY_BYTE_STRING,r=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}}class fn{constructor(){this.M=0,this.L=pn(),this.B=J.EMPTY_BYTE_STRING,this.U=!1,this.q=!0}get current(){return this.U}get resumeToken(){return this.B}get K(){return 0!==this.M}get j(){return this.q}W(t){t.approximateByteSize()>0&&(this.q=!0,this.B=t)}G(){let t=sn(),e=sn(),n=sn();return this.L.forEach(((r,s)=>{switch(s){case 0:t=t.add(r);break;case 2:e=e.add(r);break;case 1:n=n.add(r);break;default:v()}})),new un(this.B,this.U,t,e,n)}H(){this.q=!1,this.L=pn()}J(t,e){this.q=!0,this.L=this.L.insert(t,e)}Y(t){this.q=!0,this.L=this.L.remove(t)}X(){this.M+=1}Z(){this.M-=1}tt(){this.q=!0,this.U=!0}}class mn{constructor(t){this.et=t,this.nt=new Map,this.st=Xe(),this.it=gn(),this.rt=new He(P)}ot(t){for(const e of t.$)t.F&&t.F.isFoundDocument()?this.at(e,t.F):this.ct(e,t.key,t.F);for(const e of t.removedTargetIds)this.ct(e,t.key,t.F)}ut(t){this.forEachTarget(t,(e=>{const n=this.ht(e);switch(t.state){case 0:this.lt(e)&&n.W(t.resumeToken);break;case 1:n.Z(),n.K||n.H(),n.W(t.resumeToken);break;case 2:n.Z(),n.K||this.removeTarget(e);break;case 3:this.lt(e)&&(n.tt(),n.W(t.resumeToken));break;case 4:this.lt(e)&&(this.ft(e),n.W(t.resumeToken));break;default:v()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.nt.forEach(((t,n)=>{this.lt(n)&&e(n)}))}dt(t){const e=t.targetId,n=t.O.count,r=this.wt(e);if(r){const t=r.target;if(Ct(t))if(0===n){const n=new ct(t.path);this.ct(e,n,kt.newNoDocument(n,B.min()))}else I(1===n);else this._t(e)!==n&&(this.ft(e),this.rt=this.rt.add(e))}}gt(t){const e=new Map;this.nt.forEach(((n,r)=>{const s=this.wt(r);if(s){if(n.current&&Ct(s.target)){const e=new ct(s.target.path);null!==this.st.get(e)||this.yt(r,e)||this.ct(r,e,kt.newNoDocument(e,t))}n.j&&(e.set(r,n.G()),n.H())}}));let n=sn();this.it.forEach(((t,e)=>{let r=!0;e.forEachWhile((t=>{const e=this.wt(t);return!e||2===e.purpose||(r=!1,!1)})),r&&(n=n.add(t))}));const r=new cn(t,e,this.rt,this.st,n);return this.st=Xe(),this.it=gn(),this.rt=new He(P),r}at(t,e){if(!this.lt(t))return;const n=this.yt(t,e.key)?2:0;this.ht(t).J(e.key,n),this.st=this.st.insert(e.key,e),this.it=this.it.insert(e.key,this.Tt(e.key).add(t))}ct(t,e,n){if(!this.lt(t))return;const r=this.ht(t);this.yt(t,e)?r.J(e,1):r.Y(e),this.it=this.it.insert(e,this.Tt(e).delete(t)),n&&(this.st=this.st.insert(e,n))}removeTarget(t){this.nt.delete(t)}_t(t){const e=this.ht(t).G();return this.et.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}X(t){this.ht(t).X()}ht(t){let e=this.nt.get(t);return e||(e=new fn,this.nt.set(t,e)),e}Tt(t){let e=this.it.get(t);return e||(e=new He(P),this.it=this.it.insert(t,e)),e}lt(t){const e=null!==this.wt(t);return e||g("WatchChangeAggregator","Detected inactive target",t),e}wt(t){const e=this.nt.get(t);return e&&e.K?null:this.et.Et(t)}ft(t){this.nt.set(t,new fn),this.et.getRemoteKeysForTarget(t).forEach((e=>{this.ct(t,e,null)}))}yt(t,e){return this.et.getRemoteKeysForTarget(t).has(e)}}function gn(){return new ze(ct.comparator)}function pn(){return new ze(ct.comparator)}const yn={asc:"ASCENDING",desc:"DESCENDING"},wn={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class vn{constructor(t,e){this.databaseId=t,this.C=e}}function In(t,e){return t.C?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function Tn(t,e){return t.C?e.toBase64():e.toUint8Array()}function En(t,e){return In(t,e.toTimestamp())}function bn(t){return I(!!t),B.fromTimestamp(function(t){const e=Z(t);return new U(e.seconds,e.nanos)}(t))}function Sn(t,e){return function(t){return new z(["projects",t.projectId,"databases",t.database])}(t).child("documents").child(e).canonicalString()}function kn(t){const e=z.fromString(t);return I(Hn(e)),e}function _n(t,e){return Sn(t.databaseId,e.path)}function An(t,e){const n=kn(e);if(n.get(1)!==t.databaseId.projectId)throw new S(b.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new S(b.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new ct(xn(n))}function Nn(t,e){return Sn(t.databaseId,e)}function Dn(t){const e=kn(t);return 4===e.length?z.emptyPath():xn(e)}function Cn(t){return new z(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function xn(t){return I(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function Rn(t,e,n){return{name:_n(t,e),fields:n.value.mapValue.fields}}function Ln(t,e,n){const r=An(t,e.name),s=bn(e.updateTime),i=new bt({mapValue:{fields:e.fields}}),o=kt.newFoundDocument(r,s,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function Mn(t,e){let n;if(e instanceof Me)n={update:Rn(t,e.key,e.value)};else if(e instanceof qe)n={delete:_n(t,e.key)};else if(e instanceof Fe)n={update:Rn(t,e.key,e.data),updateMask:Wn(e.fieldMask)};else{if(!(e instanceof Ue))return v();n={verify:_n(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof pe)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof ye)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof ve)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Te)return{fieldPath:e.field.canonicalString(),increment:n.N};throw v()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:En(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:v()}(t,e.precondition)),n}function Fn(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?_e.updateTime(bn(t.updateTime)):void 0!==t.exists?_e.exists(t.exists):_e.none()}(e.currentDocument):_e.none(),r=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)I("REQUEST_TIME"===e.setToServerValue),n=new pe;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new ye(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new ve(t)}else"increment"in e?n=new Te(t,e.increment):v();const r=W.fromServerFormat(e.fieldPath);return new Se(r,n)}(t,e))):[];if(e.update){e.update.name;const s=An(t,e.update.name),i=new bt({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new H(e.map((t=>W.fromServerFormat(t))))}(e.updateMask);return new Fe(s,i,t,n,r)}return new Me(s,i,n,r)}if(e.delete){const r=An(t,e.delete);return new qe(r,n)}if(e.verify){const r=An(t,e.verify);return new Ue(r,n)}return v()}function On(t,e){return{documents:[Nn(t,e.path)]}}function Pn(t,e){const n={structuredQuery:{}},r=e.path;null!==e.collectionGroup?(n.parent=Nn(t,r),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=Nn(t,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);const s=function(t){if(0===t.length)return;const e=t.map((t=>function(t){if("=="===t.op){if(It(t.value))return{unaryFilter:{field:jn(t.field),op:"IS_NAN"}};if(vt(t.value))return{unaryFilter:{field:jn(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(It(t.value))return{unaryFilter:{field:jn(t.field),op:"IS_NOT_NAN"}};if(vt(t.value))return{unaryFilter:{field:jn(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:jn(t.field),op:$n(t.op),value:t.value}}}(t)));return 1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}(e.filters);s&&(n.structuredQuery.where=s);const i=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:jn(t.field),direction:Kn(t.dir)}}(t)))}(e.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(t,e){return t.C||it(e)?e:{value:e}}(t,e.limit);return null!==o&&(n.structuredQuery.limit=o),e.startAt&&(n.structuredQuery.startAt=Un(e.startAt)),e.endAt&&(n.structuredQuery.endAt=Un(e.endAt)),n}function Vn(t){let e=Dn(t.parent);const n=t.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){I(1===r);const t=n.from[0];t.allDescendants?s=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=qn(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((t=>function(t){return new Kt(Gn(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t))));let a=null;n.limit&&(a=function(t){let e;return e="object"==typeof t?t.value:t,it(e)?null:e}(n.limit));let c=null;n.startAt&&(c=Bn(n.startAt));let u=null;return n.endAt&&(u=Bn(n.endAt)),Qt(e,s,o,i,a,"F",c,u)}function qn(t){return t?void 0!==t.unaryFilter?[Qn(t)]:void 0!==t.fieldFilter?[zn(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map((t=>qn(t))).reduce(((t,e)=>t.concat(e))):v():[]}function Un(t){return{before:t.before,values:t.position}}function Bn(t){const e=!!t.before,n=t.values||[];return new Ut(n,e)}function Kn(t){return yn[t]}function $n(t){return wn[t]}function jn(t){return{fieldPath:t.canonicalString()}}function Gn(t){return W.fromServerFormat(t.fieldPath)}function zn(t){return xt.create(Gn(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return v()}}(t.fieldFilter.op),t.fieldFilter.value)}function Qn(t){switch(t.unaryFilter.op){case"IS_NAN":const e=Gn(t.unaryFilter.field);return xt.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=Gn(t.unaryFilter.field);return xt.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Gn(t.unaryFilter.field);return xt.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=Gn(t.unaryFilter.field);return xt.create(s,"!=",{nullValue:"NULL_VALUE"});default:return v()}}function Wn(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function Hn(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}function Yn(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=Xn(e)),e=Jn(t.get(n),e);return Xn(e)}function Jn(t,e){let n=e;const r=t.length;for(let s=0;s<r;s++){const e=t.charAt(s);switch(e){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=e}}return n}function Xn(t){return t+"\x01\x01"}function Zn(t){const e=t.length;if(I(e>=2),2===e)return I("\x01"===t.charAt(0)&&"\x01"===t.charAt(1)),z.emptyPath();const n=e-2,r=[];let s="";for(let i=0;i<e;){const e=t.indexOf("\x01",i);switch((e<0||e>n)&&v(),t.charAt(e+1)){case"\x01":const n=t.substring(i,e);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"\x10":s+=t.substring(i,e),s+="\0";break;case"\x11":s+=t.substring(i,e+1);break;default:v()}i=e+2}return new z(r)}class tr{constructor(t,e){this.seconds=t,this.nanoseconds=e}}class er{constructor(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}}er.store="owner",er.key="owner";class nr{constructor(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}}nr.store="mutationQueues",nr.keyPath="userId";class rr{constructor(t,e,n,r,s){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=s}}rr.store="mutations",rr.keyPath="batchId",rr.userMutationsIndex="userMutationsIndex",rr.userMutationsKeyPath=["userId","batchId"];class sr{constructor(){}static prefixForUser(t){return[t]}static prefixForPath(t,e){return[t,Yn(e)]}static key(t,e,n){return[t,Yn(e),n]}}sr.store="documentMutations",sr.PLACEHOLDER=new sr;class ir{constructor(t,e){this.path=t,this.readTime=e}}class or{constructor(t,e){this.path=t,this.version=e}}class ar{constructor(t,e,n,r,s,i){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r,this.readTime=s,this.parentPath=i}}ar.store="remoteDocuments",ar.readTimeIndex="readTimeIndex",ar.readTimeIndexPath="readTime",ar.collectionReadTimeIndex="collectionReadTimeIndex",ar.collectionReadTimeIndexPath=["parentPath","readTime"];class cr{constructor(t){this.byteSize=t}}cr.store="remoteDocumentGlobal",cr.key="remoteDocumentGlobalKey";class ur{constructor(t,e,n,r,s,i,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=s,this.lastLimboFreeSnapshotVersion=i,this.query=o}}ur.store="targets",ur.keyPath="targetId",ur.queryTargetsIndexName="queryTargetsIndex",ur.queryTargetsKeyPath=["canonicalId","targetId"];class hr{constructor(t,e,n){this.targetId=t,this.path=e,this.sequenceNumber=n}}hr.store="targetDocuments",hr.keyPath=["targetId","path"],hr.documentTargetsIndex="documentTargetsIndex",hr.documentTargetsKeyPath=["path","targetId"];class lr{constructor(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}}lr.key="targetGlobalKey",lr.store="targetGlobal";class dr{constructor(t,e){this.collectionId=t,this.parent=e}}dr.store="collectionParents",dr.keyPath=["collectionId","parent"];class fr{constructor(t,e,n,r){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r}}fr.store="clientMetadata",fr.keyPath="clientId";class mr{constructor(t,e,n){this.bundleId=t,this.createTime=e,this.version=n}}mr.store="bundles",mr.keyPath="bundleId";class gr{constructor(t,e,n){this.name=t,this.readTime=e,this.bundledQuery=n}}gr.store="namedQueries",gr.keyPath="name";const pr=[nr.store,rr.store,sr.store,ar.store,ur.store,er.store,lr.store,hr.store,fr.store,cr.store,dr.store,mr.store,gr.store],yr="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class wr{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}class vr{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&v(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new vr(((n,r)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,r)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,r)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof vr?e:vr.resolve(e)}catch(t){return vr.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):vr.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):vr.reject(e)}static resolve(t){return new vr(((e,n)=>{e(t)}))}static reject(t){return new vr(((e,n)=>{n(t)}))}static waitFor(t){return new vr(((e,n)=>{let r=0,s=0,i=!1;t.forEach((t=>{++r,t.next((()=>{++s,i&&s===r&&e()}),(t=>n(t)))})),i=!0,s===r&&e()}))}static or(t){let e=vr.resolve(!1);for(const n of t)e=e.next((t=>t?vr.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,r)=>{n.push(e.call(this,t,r))})),this.waitFor(n)}}class Ir{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.It=new k,this.transaction.oncomplete=()=>{this.It.resolve()},this.transaction.onabort=()=>{e.error?this.It.reject(new br(t,e.error)):this.It.resolve()},this.transaction.onerror=e=>{const n=Nr(e.target.error);this.It.reject(new br(t,n))}}static open(t,e,n,r){try{return new Ir(e,t.transaction(r,n))}catch(t){throw new br(e,t)}}get At(){return this.It.promise}abort(t){t&&this.It.reject(t),this.aborted||(g("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}store(t){const e=this.transaction.objectStore(t);return new kr(e)}}class Tr{constructor(t,e,n){this.name=t,this.version=e,this.Rt=n,12.2===Tr.Pt((0,o.z$)())&&p("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return g("SimpleDb","Removing database:",t),_r(window.indexedDB.deleteDatabase(t)).toPromise()}static bt(){if(!(0,o.hl)())return!1;if(Tr.vt())return!0;const t=(0,o.z$)(),e=Tr.Pt(t),n=0<e&&e<10,r=Tr.Vt(t),s=0<r&&r<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||s)}static vt(){var t;return"undefined"!=typeof c&&"YES"===(null===(t=c.env)||void 0===t?void 0:t.St)}static Dt(t,e){return t.store(e)}static Pt(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static Vt(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async Ct(t){return this.db||(g("SimpleDb","Opening database:",this.name),this.db=await new Promise(((e,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=t=>{const n=t.target.result;e(n)},r.onblocked=()=>{n(new br(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=e=>{const r=e.target.error;"VersionError"===r.name?n(new S(b.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new S(b.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new br(t,r))},r.onupgradeneeded=t=>{g("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.Rt.Nt(e,r.transaction,t.oldVersion,this.version).next((()=>{g("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.kt&&(this.db.onversionchange=t=>this.kt(t)),this.db}xt(t){this.kt=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,r){const s="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.Ct(t);const e=Ir.open(this.db,t,s?"readonly":"readwrite",n),i=r(e).catch((t=>(e.abort(t),vr.reject(t)))).toPromise();return i.catch((()=>{})),await e.At,i}catch(t){const e="FirebaseError"!==t.name&&i<3;if(g("SimpleDb","Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Er{constructor(t){this.$t=t,this.Ft=!1,this.Ot=null}get isDone(){return this.Ft}get Mt(){return this.Ot}set cursor(t){this.$t=t}done(){this.Ft=!0}Lt(t){this.Ot=t}delete(){return _r(this.$t.delete())}}class br extends S{constructor(t,e){super(b.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function Sr(t){return"IndexedDbTransactionError"===t.name}class kr{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(g("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(g("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),_r(n)}add(t){return g("SimpleDb","ADD",this.store.name,t,t),_r(this.store.add(t))}get(t){return _r(this.store.get(t)).next((e=>(void 0===e&&(e=null),g("SimpleDb","GET",this.store.name,t,e),e)))}delete(t){return g("SimpleDb","DELETE",this.store.name,t),_r(this.store.delete(t))}count(){return g("SimpleDb","COUNT",this.store.name),_r(this.store.count())}Bt(t,e){const n=this.cursor(this.options(t,e)),r=[];return this.Ut(n,((t,e)=>{r.push(e)})).next((()=>r))}qt(t,e){g("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.Kt=!1;const r=this.cursor(n);return this.Ut(r,((t,e,n)=>n.delete()))}jt(t,e){let n;e?n=t:(n={},e=t);const r=this.cursor(n);return this.Ut(r,e)}Qt(t){const e=this.cursor({});return new vr(((n,r)=>{e.onerror=t=>{const e=Nr(t.target.error);r(e)},e.onsuccess=e=>{const r=e.target.result;r?t(r.primaryKey,r.value).next((t=>{t?r.continue():n()})):n()}}))}Ut(t,e){const n=[];return new vr(((r,s)=>{t.onerror=t=>{s(t.target.error)},t.onsuccess=t=>{const s=t.target.result;if(!s)return void r();const i=new Er(s),o=e(s.primaryKey,s.value,i);if(o instanceof vr){const t=o.catch((t=>(i.done(),vr.reject(t))));n.push(t)}i.isDone?r():null===i.Mt?s.continue():s.continue(i.Mt)}})).next((()=>vr.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.Kt?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function _r(t){return new vr(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=Nr(t.target.error);n(e)}}))}let Ar=!1;function Nr(t){const e=Tr.Pt((0,o.z$)());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new S("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Ar||(Ar=!0,setTimeout((()=>{throw t}),0)),t}}return t}class Dr extends wr{constructor(t,e){super(),this.Wt=t,this.currentSequenceNumber=e}}function Cr(t,e){const n=E(t);return Tr.Dt(n.Wt,e)}class xr{constructor(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let r=0;r<this.mutations.length;r++){const e=this.mutations[r];e.key.isEqual(t.key)&&De(e,t,n[r])}}applyToLocalView(t){for(const e of this.baseMutations)e.key.isEqual(t.key)&&Ce(e,t,this.localWriteTime);for(const e of this.mutations)e.key.isEqual(t.key)&&Ce(e,t,this.localWriteTime)}applyToLocalDocumentSet(t){this.mutations.forEach((e=>{const n=t.get(e.key),r=n;this.applyToLocalView(r),n.isValidDocument()||r.convertToNoDocument(B.min())}))}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),sn())}isEqual(t){return this.batchId===t.batchId&&V(this.mutations,t.mutations,((t,e)=>Re(t,e)))&&V(this.baseMutations,t.baseMutations,((t,e)=>Re(t,e)))}}class Rr{constructor(t,e,n,r){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=r}static from(t,e,n){I(t.mutations.length===n.length);let r=nn();const s=t.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new Rr(t,e,n,r)}}class Lr{constructor(t,e,n,r,s=B.min(),i=B.min(),o=J.EMPTY_BYTE_STRING){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(t){return new Lr(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(t,e){return new Lr(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}withLastLimboFreeSnapshotVersion(t){return new Lr(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}class Mr{constructor(t){this.Gt=t}}function Fr(t,e){if(e.document)return Ln(t.Gt,e.document,!!e.hasCommittedMutations);if(e.noDocument){const t=ct.fromSegments(e.noDocument.path),n=Ur(e.noDocument.readTime),r=kt.newNoDocument(t,n);return e.hasCommittedMutations?r.setHasCommittedMutations():r}if(e.unknownDocument){const t=ct.fromSegments(e.unknownDocument.path),n=Ur(e.unknownDocument.version);return kt.newUnknownDocument(t,n)}return v()}function Or(t,e,n){const r=Pr(n),s=e.key.path.popLast().toArray();if(e.isFoundDocument()){const n=function(t,e){return{name:_n(t,e.key),fields:e.data.value.mapValue.fields,updateTime:In(t,e.version.toTimestamp())}}(t.Gt,e),i=e.hasCommittedMutations;return new ar(null,null,n,i,r,s)}if(e.isNoDocument()){const t=e.key.path.toArray(),n=qr(e.version),i=e.hasCommittedMutations;return new ar(null,new ir(t,n),null,i,r,s)}if(e.isUnknownDocument()){const t=e.key.path.toArray(),n=qr(e.version);return new ar(new or(t,n),null,null,!0,r,s)}return v()}function Pr(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function Vr(t){const e=new U(t[0],t[1]);return B.fromTimestamp(e)}function qr(t){const e=t.toTimestamp();return new tr(e.seconds,e.nanoseconds)}function Ur(t){const e=new U(t.seconds,t.nanoseconds);return B.fromTimestamp(e)}function Br(t,e){const n=(e.baseMutations||[]).map((e=>Fn(t.Gt,e)));for(let i=0;i<e.mutations.length-1;++i){const t=e.mutations[i];if(i+1<e.mutations.length&&void 0!==e.mutations[i+1].transform){const n=e.mutations[i+1];t.updateTransforms=n.transform.fieldTransforms,e.mutations.splice(i+1,1),++i}}const r=e.mutations.map((e=>Fn(t.Gt,e))),s=U.fromMillis(e.localWriteTimeMs);return new xr(e.batchId,s,n,r)}function Kr(t){const e=Ur(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?Ur(t.lastLimboFreeSnapshotVersion):B.min();let r;var s;return void 0!==t.query.documents?(I(1===(s=t.query).documents.length),r=ee(Wt(Dn(s.documents[0])))):r=function(t){return ee(Vn(t))}(t.query),new Lr(r,t.targetId,0,t.lastListenSequenceNumber,e,n,J.fromBase64String(t.resumeToken))}function $r(t,e){const n=qr(e.snapshotVersion),r=qr(e.lastLimboFreeSnapshotVersion);let s;s=Ct(e.target)?On(t.Gt,e.target):Pn(t.Gt,e.target);const i=e.resumeToken.toBase64();return new ur(e.targetId,Nt(e.target),n,i,e.sequenceNumber,r,s)}function jr(t){const e=Vn({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?ne(e,e.limit,"L"):e}class Gr{getBundleMetadata(t,e){return zr(t).get(e).next((t=>{if(t)return{id:(e=t).bundleId,createTime:Ur(e.createTime),version:e.version};var e}))}saveBundleMetadata(t,e){return zr(t).put({bundleId:(n=e).id,createTime:qr(bn(n.createTime)),version:n.version});var n}getNamedQuery(t,e){return Qr(t).get(e).next((t=>{if(t)return{name:(e=t).name,query:jr(e.bundledQuery),readTime:Ur(e.readTime)};var e}))}saveNamedQuery(t,e){return Qr(t).put(function(t){return{name:t.name,readTime:qr(bn(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function zr(t){return Cr(t,mr.store)}function Qr(t){return Cr(t,gr.store)}class Wr{constructor(){this.zt=new Hr}addToCollectionParentIndex(t,e){return this.zt.add(e),vr.resolve()}getCollectionParents(t,e){return vr.resolve(this.zt.getEntries(e))}}class Hr{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new He(z.comparator),s=!r.has(n);return this.index[e]=r.add(n),s}has(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e];return r&&r.has(n)}getEntries(t){return(this.index[t]||new He(z.comparator)).toArray()}}class Yr{constructor(){this.Ht=new Hr}addToCollectionParentIndex(t,e){if(!this.Ht.has(e)){const n=e.lastSegment(),r=e.popLast();t.addOnCommittedListener((()=>{this.Ht.add(e)}));const s={collectionId:n,parent:Yn(r)};return Jr(t).put(s)}return vr.resolve()}getCollectionParents(t,e){const n=[],r=IDBKeyRange.bound([e,""],[q(e),""],!1,!0);return Jr(t).Bt(r).next((t=>{for(const r of t){if(r.collectionId!==e)break;n.push(Zn(r.parent))}return n}))}}function Jr(t){return Cr(t,dr.store)}const Xr={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Zr{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new Zr(t,Zr.DEFAULT_COLLECTION_PERCENTILE,Zr.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function ts(t,e,n){const r=t.store(rr.store),s=t.store(sr.store),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const c=r.jt({range:o},((t,e,n)=>(a++,n.delete())));i.push(c.next((()=>{I(1===a)})));const u=[];for(const h of n.mutations){const t=sr.key(e,h.key.path,n.batchId);i.push(s.delete(t)),u.push(h.key)}return vr.waitFor(i).next((()=>u))}function es(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw v();e=t.noDocument}return JSON.stringify(e).length}Zr.DEFAULT_COLLECTION_PERCENTILE=10,Zr.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Zr.DEFAULT=new Zr(41943040,Zr.DEFAULT_COLLECTION_PERCENTILE,Zr.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Zr.DISABLED=new Zr(-1,0,0);class ns{constructor(t,e,n,r){this.userId=t,this.k=e,this.Jt=n,this.referenceDelegate=r,this.Yt={}}static Xt(t,e,n,r){I(""!==t.uid);const s=t.isAuthenticated()?t.uid:"";return new ns(s,e,n,r)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return ss(t).jt({index:rr.userMutationsIndex,range:n},((t,n,r)=>{e=!1,r.done()})).next((()=>e))}addMutationBatch(t,e,n,r){const s=is(t),i=ss(t);return i.add({}).next((o=>{I("number"==typeof o);const a=new xr(o,e,n,r),c=function(t,e,n){const r=n.baseMutations.map((e=>Mn(t.Gt,e))),s=n.mutations.map((e=>Mn(t.Gt,e)));return new rr(e,n.batchId,n.localWriteTime.toMillis(),r,s)}(this.k,this.userId,a),u=[];let h=new He(((t,e)=>P(t.canonicalString(),e.canonicalString())));for(const t of r){const e=sr.key(this.userId,t.key.path,o);h=h.add(t.key.path.popLast()),u.push(i.put(c)),u.push(s.put(e,sr.PLACEHOLDER))}return h.forEach((e=>{u.push(this.Jt.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.Yt[o]=a.keys()})),vr.waitFor(u).next((()=>a))}))}lookupMutationBatch(t,e){return ss(t).get(e).next((t=>t?(I(t.userId===this.userId),Br(this.k,t)):null))}Zt(t,e){return this.Yt[e]?vr.resolve(this.Yt[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.Yt[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return ss(t).jt({index:rr.userMutationsIndex,range:r},((t,e,r)=>{e.userId===this.userId&&(I(e.batchId>=n),s=Br(this.k,e)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return ss(t).jt({index:rr.userMutationsIndex,range:e,reverse:!0},((t,e,r)=>{n=e.batchId,r.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return ss(t).Bt(rr.userMutationsIndex,e).next((t=>t.map((t=>Br(this.k,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=sr.prefixForPath(this.userId,e.path),r=IDBKeyRange.lowerBound(n),s=[];return is(t).jt({range:r},((n,r,i)=>{const[o,a,c]=n,u=Zn(a);if(o===this.userId&&e.path.isEqual(u))return ss(t).get(c).next((t=>{if(!t)throw v();I(t.userId===this.userId),s.push(Br(this.k,t))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new He(P);const r=[];return e.forEach((e=>{const s=sr.prefixForPath(this.userId,e.path),i=IDBKeyRange.lowerBound(s),o=is(t).jt({range:i},((t,r,s)=>{const[i,o,a]=t,c=Zn(o);i===this.userId&&e.path.isEqual(c)?n=n.add(a):s.done()}));r.push(o)})),vr.waitFor(r).next((()=>this.te(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1,s=sr.prefixForPath(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new He(P);return is(t).jt({range:i},((t,e,s)=>{const[i,a,c]=t,u=Zn(a);i===this.userId&&n.isPrefixOf(u)?u.length===r&&(o=o.add(c)):s.done()})).next((()=>this.te(t,o)))}te(t,e){const n=[],r=[];return e.forEach((e=>{r.push(ss(t).get(e).next((t=>{if(null===t)throw v();I(t.userId===this.userId),n.push(Br(this.k,t))})))})),vr.waitFor(r).next((()=>n))}removeMutationBatch(t,e){return ts(t.Wt,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this.ee(e.batchId)})),vr.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}ee(t){delete this.Yt[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return vr.resolve();const n=IDBKeyRange.lowerBound(sr.prefixForUser(this.userId)),r=[];return is(t).jt({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=Zn(t[1]);r.push(e)}else n.done()})).next((()=>{I(0===r.length)}))}))}containsKey(t,e){return rs(t,this.userId,e)}ne(t){return os(t).get(this.userId).next((t=>t||new nr(this.userId,-1,"")))}}function rs(t,e,n){const r=sr.prefixForPath(e,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return is(t).jt({range:i,Kt:!0},((t,n,r)=>{const[i,a,c]=t;i===e&&a===s&&(o=!0),r.done()})).next((()=>o))}function ss(t){return Cr(t,rr.store)}function is(t){return Cr(t,sr.store)}function os(t){return Cr(t,nr.store)}class as{constructor(t){this.se=t}next(){return this.se+=2,this.se}static ie(){return new as(0)}static re(){return new as(-1)}}class cs{constructor(t,e){this.referenceDelegate=t,this.k=e}allocateTargetId(t){return this.oe(t).next((e=>{const n=new as(e.highestTargetId);return e.highestTargetId=n.next(),this.ae(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.oe(t).next((t=>B.fromTimestamp(new U(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.oe(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.oe(t).next((r=>(r.highestListenSequenceNumber=e,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),e>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=e),this.ae(t,r))))}addTargetData(t,e){return this.ce(t,e).next((()=>this.oe(t).next((n=>(n.targetCount+=1,this.ue(e,n),this.ae(t,n))))))}updateTargetData(t,e){return this.ce(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>us(t).delete(e.targetId))).next((()=>this.oe(t))).next((e=>(I(e.targetCount>0),e.targetCount-=1,this.ae(t,e))))}removeTargets(t,e,n){let r=0;const s=[];return us(t).jt(((i,o)=>{const a=Kr(o);a.sequenceNumber<=e&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(t,a)))})).next((()=>vr.waitFor(s))).next((()=>r))}forEachTarget(t,e){return us(t).jt(((t,n)=>{const r=Kr(n);e(r)}))}oe(t){return hs(t).get(lr.key).next((t=>(I(null!==t),t)))}ae(t,e){return hs(t).put(lr.key,e)}ce(t,e){return us(t).put($r(this.k,e))}ue(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.oe(t).next((t=>t.targetCount))}getTargetData(t,e){const n=Nt(e),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return us(t).jt({range:r,index:ur.queryTargetsIndexName},((t,n,r)=>{const i=Kr(n);Dt(e,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(t,e,n){const r=[],s=ls(t);return e.forEach((e=>{const i=Yn(e.path);r.push(s.put(new hr(n,i))),r.push(this.referenceDelegate.addReference(t,n,e))})),vr.waitFor(r)}removeMatchingKeys(t,e,n){const r=ls(t);return vr.forEach(e,(e=>{const s=Yn(e.path);return vr.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=ls(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),r=ls(t);let s=sn();return r.jt({range:n,Kt:!0},((t,e,n)=>{const r=Zn(t[1]),i=new ct(r);s=s.add(i)})).next((()=>s))}containsKey(t,e){const n=Yn(e.path),r=IDBKeyRange.bound([n],[q(n)],!1,!0);let s=0;return ls(t).jt({index:hr.documentTargetsIndex,Kt:!0,range:r},(([t,e],n,r)=>{0!==t&&(s++,r.done())})).next((()=>s>0))}Et(t,e){return us(t).get(e).next((t=>t?Kr(t):null))}}function us(t){return Cr(t,ur.store)}function hs(t){return Cr(t,lr.store)}function ls(t){return Cr(t,hr.store)}async function ds(t){if(t.code!==b.FAILED_PRECONDITION||t.message!==yr)throw t;g("LocalStore","Unexpectedly lost primary lease")}function fs([t,e],[n,r]){const s=P(t,n);return 0===s?P(e,r):s}class ms{constructor(t){this.he=t,this.buffer=new He(fs),this.le=0}fe(){return++this.le}de(t){const e=[t,this.fe()];if(this.buffer.size<this.he)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();fs(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class gs{constructor(t,e){this.garbageCollector=t,this.asyncQueue=e,this.we=!1,this._e=null}start(t){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.me(t)}stop(){this._e&&(this._e.cancel(),this._e=null)}get started(){return null!==this._e}me(t){const e=this.we?3e5:6e4;g("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this._e=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this._e=null,this.we=!0;try{await t.collectGarbage(this.garbageCollector)}catch(t){Sr(t)?g("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await ds(t)}await this.me(t)}))}}class ps{constructor(t,e){this.ge=t,this.params=e}calculateTargetCount(t,e){return this.ge.ye(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return vr.resolve(M.I);const n=new ms(e);return this.ge.forEachTarget(t,(t=>n.de(t.sequenceNumber))).next((()=>this.ge.pe(t,(t=>n.de(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.ge.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.ge.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector","Garbage collection skipped; disabled"),vr.resolve(Xr)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Xr):this.Te(t,e)))}getCacheSize(t){return this.ge.getCacheSize(t)}Te(t,e){let n,r,s,o,a,c,u;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(g("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),r=this.params.maximumSequenceNumbersToCollect):r=e,o=Date.now(),this.nthSequenceNumber(t,r)))).next((r=>(n=r,a=Date.now(),this.removeTargets(t,n,e)))).next((e=>(s=e,c=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(u=Date.now(),f()<=i.in.DEBUG&&g("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-h}ms\n\tDetermined least recently used ${r} in `+(a-o)+"ms\n"+`\tRemoved ${s} targets in `+(c-a)+"ms\n"+`\tRemoved ${t} documents in `+(u-c)+"ms\n"+`Total Duration: ${u-h}ms`),vr.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:t}))))}}class ys{constructor(t,e){this.db=t,this.garbageCollector=function(t,e){return new ps(t,e)}(this,e)}ye(t){const e=this.Ee(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}Ee(t){let e=0;return this.pe(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}pe(t,e){return this.Ie(t,((t,n)=>e(n)))}addReference(t,e,n){return ws(t,n)}removeReference(t,e,n){return ws(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return ws(t,e)}Ae(t,e){return function(t,e){let n=!1;return os(t).Qt((r=>rs(t,r,e).next((t=>(t&&(n=!0),vr.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Ie(t,((i,o)=>{if(o<=e){const e=this.Ae(t,i).next((e=>{if(!e)return s++,n.getEntry(t,i).next((()=>(n.removeEntry(i),ls(t).delete([0,Yn(i.path)]))))}));r.push(e)}})).next((()=>vr.waitFor(r))).next((()=>n.apply(t))).next((()=>s))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return ws(t,e)}Ie(t,e){const n=ls(t);let r,s=M.I;return n.jt({index:hr.documentTargetsIndex},(([t,n],{path:i,sequenceNumber:o})=>{0===t?(s!==M.I&&e(new ct(Zn(r)),s),s=o,r=i):s=M.I})).next((()=>{s!==M.I&&e(new ct(Zn(r)),s)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function ws(t,e){return ls(t).put(function(t,e){return new hr(0,Yn(t.path),e)}(e,t.currentSequenceNumber))}class vs{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={}}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[r,s]of n)if(this.equalsFn(r,t))return s}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),r=this.inner[n];if(void 0!==r){for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],t))return void(r[n]=[t,e]);r.push([t,e])}else this.inner[n]=[[t,e]]}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return 1===n.length?delete this.inner[e]:n.splice(r,1),!0;return!1}forEach(t){$(this.inner,((e,n)=>{for(const[r,s]of n)t(r,s)}))}isEmpty(){return j(this.inner)}}class Is{constructor(){this.changes=new vs((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}getReadTime(t){const e=this.changes.get(t);return e?e.readTime:B.min()}addEntry(t,e){this.assertNotApplied(),this.changes.set(t.key,{document:t,readTime:e})}removeEntry(t,e=null){this.assertNotApplied(),this.changes.set(t,{document:kt.newInvalidDocument(t),readTime:e})}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?vr.resolve(n.document):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class Ts{constructor(t,e){this.k=t,this.Jt=e}addEntry(t,e,n){return Ss(t).put(ks(e),n)}removeEntry(t,e){const n=Ss(t),r=ks(e);return n.delete(r)}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.Re(t,n))))}getEntry(t,e){return Ss(t).get(ks(e)).next((t=>this.Pe(e,t)))}be(t,e){return Ss(t).get(ks(e)).next((t=>({document:this.Pe(e,t),size:es(t)})))}getEntries(t,e){let n=Xe();return this.ve(t,e,((t,e)=>{const r=this.Pe(t,e);n=n.insert(t,r)})).next((()=>n))}Ve(t,e){let n=Xe(),r=new ze(ct.comparator);return this.ve(t,e,((t,e)=>{const s=this.Pe(t,e);n=n.insert(t,s),r=r.insert(t,es(e))})).next((()=>({documents:n,Se:r})))}ve(t,e,n){if(e.isEmpty())return vr.resolve();const r=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),s=e.getIterator();let i=s.getNext();return Ss(t).jt({range:r},((t,e,r)=>{const o=ct.fromSegments(t);for(;i&&ct.comparator(i,o)<0;)n(i,null),i=s.getNext();i&&i.isEqual(o)&&(n(i,e),i=s.hasNext()?s.getNext():null),i?r.Lt(i.path.toArray()):r.done()})).next((()=>{for(;i;)n(i,null),i=s.hasNext()?s.getNext():null}))}getDocumentsMatchingQuery(t,e,n){let r=Xe();const s=e.path.length+1,i={};if(n.isEqual(B.min())){const t=e.path.toArray();i.range=IDBKeyRange.lowerBound(t)}else{const t=e.path.toArray(),r=Pr(n);i.range=IDBKeyRange.lowerBound([t,r],!0),i.index=ar.collectionReadTimeIndex}return Ss(t).jt(i,((t,n,i)=>{if(t.length!==s)return;const o=Fr(this.k,n);e.path.isPrefixOf(o.key.path)?oe(e,o)&&(r=r.insert(o.key,o)):i.done()})).next((()=>r))}newChangeBuffer(t){return new Es(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return bs(t).get(cr.key).next((t=>(I(!!t),t)))}Re(t,e){return bs(t).put(cr.key,e)}Pe(t,e){if(e){const t=Fr(this.k,e);if(!t.isNoDocument()||!t.version.isEqual(B.min()))return t}return kt.newInvalidDocument(t)}}class Es extends Is{constructor(t,e){super(),this.De=t,this.trackRemovals=e,this.Ce=new vs((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,r=new He(((t,e)=>P(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.Ce.get(s);if(i.document.isValidDocument()){const a=Or(this.De.k,i.document,this.getReadTime(s));r=r.add(s.path.popLast());const c=es(a);n+=c-o,e.push(this.De.addEntry(t,s,a))}else if(n-=o,this.trackRemovals){const n=Or(this.De.k,kt.newNoDocument(s,B.min()),this.getReadTime(s));e.push(this.De.addEntry(t,s,n))}else e.push(this.De.removeEntry(t,s))})),r.forEach((n=>{e.push(this.De.Jt.addToCollectionParentIndex(t,n))})),e.push(this.De.updateMetadata(t,n)),vr.waitFor(e)}getFromCache(t,e){return this.De.be(t,e).next((t=>(this.Ce.set(e,t.size),t.document)))}getAllFromCache(t,e){return this.De.Ve(t,e).next((({documents:t,Se:e})=>(e.forEach(((t,e)=>{this.Ce.set(t,e)})),t)))}}function bs(t){return Cr(t,cr.store)}function Ss(t){return Cr(t,ar.store)}function ks(t){return t.path.toArray()}class _s{constructor(t){this.k=t}Nt(t,e,n,r){I(n<r&&n>=0&&r<=11);const s=new Ir("createOrUpgrade",e);n<1&&r>=1&&(function(t){t.createObjectStore(er.store)}(t),function(t){t.createObjectStore(nr.store,{keyPath:nr.keyPath}),t.createObjectStore(rr.store,{keyPath:rr.keyPath,autoIncrement:!0}).createIndex(rr.userMutationsIndex,rr.userMutationsKeyPath,{unique:!0}),t.createObjectStore(sr.store)}(t),As(t),function(t){t.createObjectStore(ar.store)}(t));let i=vr.resolve();return n<3&&r>=3&&(0!==n&&(function(t){t.deleteObjectStore(hr.store),t.deleteObjectStore(ur.store),t.deleteObjectStore(lr.store)}(t),As(t)),i=i.next((()=>function(t){const e=t.store(lr.store),n=new lr(0,0,B.min().toTimestamp(),0);return e.put(lr.key,n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(t,e){return e.store(rr.store).Bt().next((n=>{t.deleteObjectStore(rr.store),t.createObjectStore(rr.store,{keyPath:rr.keyPath,autoIncrement:!0}).createIndex(rr.userMutationsIndex,rr.userMutationsKeyPath,{unique:!0});const r=e.store(rr.store),s=n.map((t=>r.put(t)));return vr.waitFor(s)}))}(t,s)))),i=i.next((()=>{!function(t){t.createObjectStore(fr.store,{keyPath:fr.keyPath})}(t)}))),n<5&&r>=5&&(i=i.next((()=>this.Ne(s)))),n<6&&r>=6&&(i=i.next((()=>(function(t){t.createObjectStore(cr.store)}(t),this.ke(s))))),n<7&&r>=7&&(i=i.next((()=>this.xe(s)))),n<8&&r>=8&&(i=i.next((()=>this.$e(t,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t),function(t){const e=t.objectStore(ar.store);e.createIndex(ar.readTimeIndex,ar.readTimeIndexPath,{unique:!1}),e.createIndex(ar.collectionReadTimeIndex,ar.collectionReadTimeIndexPath,{unique:!1})}(e)}))),n<10&&r>=10&&(i=i.next((()=>this.Fe(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(t){t.createObjectStore(mr.store,{keyPath:mr.keyPath})}(t),function(t){t.createObjectStore(gr.store,{keyPath:gr.keyPath})}(t)}))),i}ke(t){let e=0;return t.store(ar.store).jt(((t,n)=>{e+=es(n)})).next((()=>{const n=new cr(e);return t.store(cr.store).put(cr.key,n)}))}Ne(t){const e=t.store(nr.store),n=t.store(rr.store);return e.Bt().next((e=>vr.forEach(e,(e=>{const r=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.Bt(rr.userMutationsIndex,r).next((n=>vr.forEach(n,(n=>{I(n.userId===e.userId);const r=Br(this.k,n);return ts(t,e.userId,r).next((()=>{}))}))))}))))}xe(t){const e=t.store(hr.store),n=t.store(ar.store);return t.store(lr.store).get(lr.key).next((t=>{const r=[];return n.jt(((n,s)=>{const i=new z(n),o=function(t){return[0,Yn(t)]}(i);r.push(e.get(o).next((n=>n?vr.resolve():(n=>e.put(new hr(0,Yn(n),t.highestListenSequenceNumber)))(i))))})).next((()=>vr.waitFor(r)))}))}$e(t,e){t.createObjectStore(dr.store,{keyPath:dr.keyPath});const n=e.store(dr.store),r=new Hr,s=t=>{if(r.add(t)){const e=t.lastSegment(),r=t.popLast();return n.put({collectionId:e,parent:Yn(r)})}};return e.store(ar.store).jt({Kt:!0},((t,e)=>{const n=new z(t);return s(n.popLast())})).next((()=>e.store(sr.store).jt({Kt:!0},(([t,e,n],r)=>{const i=Zn(e);return s(i.popLast())}))))}Fe(t){const e=t.store(ur.store);return e.jt(((t,n)=>{const r=Kr(n),s=$r(this.k,r);return e.put(s)}))}}function As(t){t.createObjectStore(hr.store,{keyPath:hr.keyPath}).createIndex(hr.documentTargetsIndex,hr.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(ur.store,{keyPath:ur.keyPath}).createIndex(ur.queryTargetsIndexName,ur.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(lr.store)}const Ns="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Ds{constructor(t,e,n,r,s,i,o,a,c,u){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.Oe=s,this.window=i,this.document=o,this.Me=c,this.Le=u,this.Be=null,this.Ue=!1,this.isPrimary=!1,this.networkEnabled=!0,this.qe=null,this.inForeground=!1,this.Ke=null,this.je=null,this.Qe=Number.NEGATIVE_INFINITY,this.We=t=>Promise.resolve(),!Ds.bt())throw new S(b.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new ys(this,r),this.Ge=e+"main",this.k=new Mr(a),this.ze=new Tr(this.Ge,11,new _s(this.k)),this.He=new cs(this.referenceDelegate,this.k),this.Jt=new Yr,this.Je=function(t,e){return new Ts(t,e)}(this.k,this.Jt),this.Ye=new Gr,this.window&&this.window.localStorage?this.Xe=this.window.localStorage:(this.Xe=null,!1===u&&p("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ze().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new S(b.FAILED_PRECONDITION,Ns);return this.tn(),this.en(),this.nn(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.He.getHighestSequenceNumber(t)))})).then((t=>{this.Be=new M(t,this.Me)})).then((()=>{this.Ue=!0})).catch((t=>(this.ze&&this.ze.close(),Promise.reject(t))))}sn(t){return this.We=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.ze.xt((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.Oe.enqueueAndForget((async()=>{this.started&&await this.Ze()})))}Ze(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>xs(t).put(new fr(this.clientId,Date.now(),this.networkEnabled,this.inForeground)).next((()=>{if(this.isPrimary)return this.rn(t).next((t=>{t||(this.isPrimary=!1,this.Oe.enqueueRetryable((()=>this.We(!1))))}))})).next((()=>this.on(t))).next((e=>this.isPrimary&&!e?this.an(t).next((()=>!1)):!!e&&this.cn(t).next((()=>!0)))))).catch((t=>{if(Sr(t))return g("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return g("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.Oe.enqueueRetryable((()=>this.We(t))),this.isPrimary=t}))}rn(t){return Cs(t).get(er.key).next((t=>vr.resolve(this.un(t))))}hn(t){return xs(t).delete(this.clientId)}async ln(){if(this.isPrimary&&!this.fn(this.Qe,18e5)){this.Qe=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=Cr(t,fr.store);return e.Bt().next((t=>{const n=this.dn(t,18e5),r=t.filter((t=>-1===n.indexOf(t)));return vr.forEach(r,(t=>e.delete(t.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.Xe)for(const e of t)this.Xe.removeItem(this.wn(e.clientId))}}nn(){this.je=this.Oe.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.Ze().then((()=>this.ln())).then((()=>this.nn()))))}un(t){return!!t&&t.ownerId===this.clientId}on(t){return this.Le?vr.resolve(!0):Cs(t).get(er.key).next((e=>{if(null!==e&&this.fn(e.leaseTimestampMs,5e3)&&!this._n(e.ownerId)){if(this.un(e)&&this.networkEnabled)return!0;if(!this.un(e)){if(!e.allowTabSynchronization)throw new S(b.FAILED_PRECONDITION,Ns);return!1}}return!(!this.networkEnabled||!this.inForeground)||xs(t).Bt().next((t=>void 0===this.dn(t,5e3).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,r=this.networkEnabled===t.networkEnabled;if(e||n&&r)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&g("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.Ue=!1,this.mn(),this.je&&(this.je.cancel(),this.je=null),this.gn(),this.yn(),await this.ze.runTransaction("shutdown","readwrite",[er.store,fr.store],(t=>{const e=new Dr(t,M.I);return this.an(e).next((()=>this.hn(e)))})),this.ze.close(),this.pn()}dn(t,e){return t.filter((t=>this.fn(t.updateTimeMs,e)&&!this._n(t.clientId)))}Tn(){return this.runTransaction("getActiveClients","readonly",(t=>xs(t).Bt().next((t=>this.dn(t,18e5).map((t=>t.clientId))))))}get started(){return this.Ue}getMutationQueue(t){return ns.Xt(t,this.k,this.Jt,this.referenceDelegate)}getTargetCache(){return this.He}getRemoteDocumentCache(){return this.Je}getIndexManager(){return this.Jt}getBundleCache(){return this.Ye}runTransaction(t,e,n){g("IndexedDbPersistence","Starting transaction:",t);const r="readonly"===e?"readonly":"readwrite";let s;return this.ze.runTransaction(t,r,pr,(r=>(s=new Dr(r,this.Be?this.Be.next():M.I),"readwrite-primary"===e?this.rn(s).next((t=>!!t||this.on(s))).next((e=>{if(!e)throw p(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Oe.enqueueRetryable((()=>this.We(!1))),new S(b.FAILED_PRECONDITION,yr);return n(s)})).next((t=>this.cn(s).next((()=>t)))):this.En(s).next((()=>n(s)))))).then((t=>(s.raiseOnCommittedEvent(),t)))}En(t){return Cs(t).get(er.key).next((t=>{if(null!==t&&this.fn(t.leaseTimestampMs,5e3)&&!this._n(t.ownerId)&&!this.un(t)&&!(this.Le||this.allowTabSynchronization&&t.allowTabSynchronization))throw new S(b.FAILED_PRECONDITION,Ns)}))}cn(t){const e=new er(this.clientId,this.allowTabSynchronization,Date.now());return Cs(t).put(er.key,e)}static bt(){return Tr.bt()}an(t){const e=Cs(t);return e.get(er.key).next((t=>this.un(t)?(g("IndexedDbPersistence","Releasing primary lease."),e.delete(er.key)):vr.resolve()))}fn(t,e){const n=Date.now();return!(t<n-e)&&(!(t>n)||(p(`Detected an update time that is in the future: ${t} > ${n}`),!1))}tn(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ke=()=>{this.Oe.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.Ze())))},this.document.addEventListener("visibilitychange",this.Ke),this.inForeground="visible"===this.document.visibilityState)}gn(){this.Ke&&(this.document.removeEventListener("visibilitychange",this.Ke),this.Ke=null)}en(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.qe=()=>{this.mn(),(0,o.G6)()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Oe.enterRestrictedMode(!0),this.Oe.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.qe))}yn(){this.qe&&(this.window.removeEventListener("pagehide",this.qe),this.qe=null)}_n(t){var e;try{const n=null!==(null===(e=this.Xe)||void 0===e?void 0:e.getItem(this.wn(t)));return g("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return p("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}mn(){if(this.Xe)try{this.Xe.setItem(this.wn(this.clientId),String(Date.now()))}catch(t){p("Failed to set zombie client id.",t)}}pn(){if(this.Xe)try{this.Xe.removeItem(this.wn(this.clientId))}catch(t){}}wn(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function Cs(t){return Cr(t,er.store)}function xs(t){return Cr(t,fr.store)}function Rs(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class Ls{constructor(t,e){this.progress=t,this.In=e}}class Ms{constructor(t,e,n){this.Je=t,this.An=e,this.Jt=n}Rn(t,e){return this.An.getAllMutationBatchesAffectingDocumentKey(t,e).next((n=>this.Pn(t,e,n)))}Pn(t,e,n){return this.Je.getEntry(t,e).next((t=>{for(const e of n)e.applyToLocalView(t);return t}))}bn(t,e){t.forEach(((t,n)=>{for(const r of e)r.applyToLocalView(n)}))}vn(t,e){return this.Je.getEntries(t,e).next((e=>this.Vn(t,e).next((()=>e))))}Vn(t,e){return this.An.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>this.bn(e,t)))}getDocumentsMatchingQuery(t,e,n){return function(t){return ct.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.Sn(t,e.path):Zt(e)?this.Dn(t,e,n):this.Cn(t,e,n)}Sn(t,e){return this.Rn(t,new ct(e)).next((t=>{let e=tn();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}Dn(t,e,n){const r=e.collectionGroup;let s=tn();return this.Jt.getCollectionParents(t,r).next((i=>vr.forEach(i,(i=>{const o=function(t,e){return new zt(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,i.child(r));return this.Cn(t,o,n).next((t=>{t.forEach(((t,e)=>{s=s.insert(t,e)}))}))})).next((()=>s))))}Cn(t,e,n){let r,s;return this.Je.getDocumentsMatchingQuery(t,e,n).next((n=>(r=n,this.An.getAllMutationBatchesAffectingQuery(t,e)))).next((e=>(s=e,this.Nn(t,s,r).next((t=>{r=t;for(const e of s)for(const t of e.mutations){const n=t.key;let s=r.get(n);null==s&&(s=kt.newInvalidDocument(n),r=r.insert(n,s)),Ce(t,s,e.localWriteTime),s.isFoundDocument()||(r=r.remove(n))}}))))).next((()=>(r.forEach(((t,n)=>{oe(e,n)||(r=r.remove(t))})),r)))}Nn(t,e,n){let r=sn();for(const i of e)for(const t of i.mutations)t instanceof Fe&&null===n.get(t.key)&&(r=r.add(t.key));let s=n;return this.Je.getEntries(t,r).next((t=>(t.forEach(((t,e)=>{e.isFoundDocument()&&(s=s.insert(t,e))})),s)))}}class Fs{constructor(t,e,n,r){this.targetId=t,this.fromCache=e,this.kn=n,this.xn=r}static $n(t,e){let n=sn(),r=sn();for(const s of e.docChanges)switch(s.type){case 0:n=n.add(s.doc.key);break;case 1:r=r.add(s.doc.key)}return new Fs(t,e.fromCache,n,r)}}class Os{Fn(t){this.On=t}getDocumentsMatchingQuery(t,e,n,r){return function(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}(e)||n.isEqual(B.min())?this.Mn(t,e):this.On.vn(t,r).next((s=>{const o=this.Ln(e,s);return(Ht(e)||Yt(e))&&this.Bn(e.limitType,o,r,n)?this.Mn(t,e):(f()<=i.in.DEBUG&&g("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),ie(e)),this.On.getDocumentsMatchingQuery(t,e,n).next((t=>(o.forEach((e=>{t=t.insert(e.key,e)})),t))))}))}Ln(t,e){let n=new He(ae(t));return e.forEach(((e,r)=>{oe(t,r)&&(n=n.add(r))})),n}Bn(t,e,n,r){if(n.size!==e.size)return!0;const s="F"===t?e.last():e.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Mn(t,e){return f()<=i.in.DEBUG&&g("QueryEngine","Using full collection scan to execute query:",ie(e)),this.On.getDocumentsMatchingQuery(t,e,B.min())}}class Ps{constructor(t,e,n,r){this.persistence=t,this.Un=e,this.k=r,this.qn=new ze(P),this.Kn=new vs((t=>Nt(t)),Dt),this.jn=B.min(),this.An=t.getMutationQueue(n),this.Qn=t.getRemoteDocumentCache(),this.He=t.getTargetCache(),this.Wn=new Ms(this.Qn,this.An,this.persistence.getIndexManager()),this.Ye=t.getBundleCache(),this.Un.Fn(this.Wn)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.qn)))}}function Vs(t,e,n,r){return new Ps(t,e,n,r)}async function qs(t,e){const n=E(t);let r=n.An,s=n.Wn;const i=await n.persistence.runTransaction("Handle user change","readonly",(t=>{let i;return n.An.getAllMutationBatches(t).next((o=>(i=o,r=n.persistence.getMutationQueue(e),s=new Ms(n.Qn,r,n.persistence.getIndexManager()),r.getAllMutationBatches(t)))).next((e=>{const n=[],r=[];let o=sn();for(const t of i){n.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){r.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return s.vn(t,o).next((t=>({Gn:t,removedBatchIds:n,addedBatchIds:r})))}))}));return n.An=r,n.Wn=s,n.Un.Fn(n.Wn),i}function Us(t){const e=E(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.He.getLastRemoteSnapshotVersion(t)))}function Bs(t,e,n,r,s){let i=sn();return n.forEach((t=>i=i.add(t))),e.getEntries(t,i).next((t=>{let i=Xe();return n.forEach(((n,o)=>{const a=t.get(n),c=(null==s?void 0:s.get(n))||r;o.isNoDocument()&&o.version.isEqual(B.min())?(e.removeEntry(n,c),i=i.insert(n,o)):!a.isValidDocument()||o.version.compareTo(a.version)>0||0===o.version.compareTo(a.version)&&a.hasPendingWrites?(e.addEntry(o,c),i=i.insert(n,o)):g("LocalStore","Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",o.version)})),i}))}function Ks(t,e){const n=E(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=-1),n.An.getNextMutationBatchAfterBatchId(t,e))))}function $s(t,e){const n=E(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let r;return n.He.getTargetData(t,e).next((s=>s?(r=s,vr.resolve(r)):n.He.allocateTargetId(t).next((s=>(r=new Lr(e,s,0,t.currentSequenceNumber),n.He.addTargetData(t,r).next((()=>r)))))))})).then((t=>{const r=n.qn.get(t.targetId);return(null===r||t.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.qn=n.qn.insert(t.targetId,t),n.Kn.set(e,t.targetId)),t}))}async function js(t,e,n){const r=E(t),s=r.qn.get(e),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(t=>r.persistence.referenceDelegate.removeTarget(t,s)))}catch(t){if(!Sr(t))throw t;g("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}r.qn=r.qn.remove(e),r.Kn.delete(s.target)}function Gs(t,e,n){const r=E(t);let s=B.min(),i=sn();return r.persistence.runTransaction("Execute query","readonly",(t=>function(t,e,n){const r=E(t),s=r.Kn.get(n);return void 0!==s?vr.resolve(r.qn.get(s)):r.He.getTargetData(e,n)}(r,t,ee(e)).next((e=>{if(e)return s=e.lastLimboFreeSnapshotVersion,r.He.getMatchingKeysForTargetId(t,e.targetId).next((t=>{i=t}))})).next((()=>r.Un.getDocumentsMatchingQuery(t,e,n?s:B.min(),n?i:sn()))).next((t=>({documents:t,zn:i})))))}function zs(t,e){const n=E(t),r=E(n.He),s=n.qn.get(e);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(t=>r.Et(t,e).next((t=>t?t.target:null))))}function Qs(t){const e=E(t);return e.persistence.runTransaction("Get new document changes","readonly",(t=>function(t,e,n){const r=E(t);let s=Xe(),i=Pr(n);const o=Ss(e),a=IDBKeyRange.lowerBound(i,!0);return o.jt({index:ar.readTimeIndex,range:a},((t,e)=>{const n=Fr(r.k,e);s=s.insert(n.key,n),i=e.readTime})).next((()=>({In:s,readTime:Vr(i)})))}(e.Qn,t,e.jn))).then((({In:t,readTime:n})=>(e.jn=n,t)))}async function Ws(t,e,n=sn()){const r=await $s(t,ee(jr(e.bundledQuery))),s=E(t);return s.persistence.runTransaction("Save named query","readwrite",(t=>{const i=bn(e.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.Ye.saveNamedQuery(t,e);const o=r.withResumeToken(J.EMPTY_BYTE_STRING,i);return s.qn=s.qn.insert(o.targetId,o),s.He.updateTargetData(t,o).next((()=>s.He.removeMatchingKeysForTargetId(t,r.targetId))).next((()=>s.He.addMatchingKeys(t,n,r.targetId))).next((()=>s.Ye.saveNamedQuery(t,e)))}))}class Hs{constructor(t){this.k=t,this.Xn=new Map,this.Zn=new Map}getBundleMetadata(t,e){return vr.resolve(this.Xn.get(e))}saveBundleMetadata(t,e){var n;return this.Xn.set(e.id,{id:(n=e).id,version:n.version,createTime:bn(n.createTime)}),vr.resolve()}getNamedQuery(t,e){return vr.resolve(this.Zn.get(e))}saveNamedQuery(t,e){return this.Zn.set(e.name,function(t){return{name:t.name,query:jr(t.bundledQuery),readTime:bn(t.readTime)}}(e)),vr.resolve()}}class Ys{constructor(){this.ts=new He(Js.es),this.ns=new He(Js.ss)}isEmpty(){return this.ts.isEmpty()}addReference(t,e){const n=new Js(t,e);this.ts=this.ts.add(n),this.ns=this.ns.add(n)}rs(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.os(new Js(t,e))}cs(t,e){t.forEach((t=>this.removeReference(t,e)))}us(t){const e=new ct(new z([])),n=new Js(e,t),r=new Js(e,t+1),s=[];return this.ns.forEachInRange([n,r],(t=>{this.os(t),s.push(t.key)})),s}hs(){this.ts.forEach((t=>this.os(t)))}os(t){this.ts=this.ts.delete(t),this.ns=this.ns.delete(t)}ls(t){const e=new ct(new z([])),n=new Js(e,t),r=new Js(e,t+1);let s=sn();return this.ns.forEachInRange([n,r],(t=>{s=s.add(t.key)})),s}containsKey(t){const e=new Js(t,0),n=this.ts.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class Js{constructor(t,e){this.key=t,this.fs=e}static es(t,e){return ct.comparator(t.key,e.key)||P(t.fs,e.fs)}static ss(t,e){return P(t.fs,e.fs)||ct.comparator(t.key,e.key)}}class Xs{constructor(t,e){this.Jt=t,this.referenceDelegate=e,this.An=[],this.ds=1,this.ws=new He(Js.es)}checkEmpty(t){return vr.resolve(0===this.An.length)}addMutationBatch(t,e,n,r){const s=this.ds;this.ds++,this.An.length>0&&this.An[this.An.length-1];const i=new xr(s,e,n,r);this.An.push(i);for(const o of r)this.ws=this.ws.add(new Js(o.key,s)),this.Jt.addToCollectionParentIndex(t,o.key.path.popLast());return vr.resolve(i)}lookupMutationBatch(t,e){return vr.resolve(this._s(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=this.gs(n),s=r<0?0:r;return vr.resolve(this.An.length>s?this.An[s]:null)}getHighestUnacknowledgedBatchId(){return vr.resolve(0===this.An.length?-1:this.ds-1)}getAllMutationBatches(t){return vr.resolve(this.An.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new Js(e,0),r=new Js(e,Number.POSITIVE_INFINITY),s=[];return this.ws.forEachInRange([n,r],(t=>{const e=this._s(t.fs);s.push(e)})),vr.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new He(P);return e.forEach((t=>{const e=new Js(t,0),r=new Js(t,Number.POSITIVE_INFINITY);this.ws.forEachInRange([e,r],(t=>{n=n.add(t.fs)}))})),vr.resolve(this.ys(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1;let s=n;ct.isDocumentKey(s)||(s=s.child(""));const i=new Js(new ct(s),0);let o=new He(P);return this.ws.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(o=o.add(t.fs)),!0)}),i),vr.resolve(this.ys(o))}ys(t){const e=[];return t.forEach((t=>{const n=this._s(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){I(0===this.ps(e.batchId,"removed")),this.An.shift();let n=this.ws;return vr.forEach(e.mutations,(r=>{const s=new Js(r.key,e.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(t,r.key)})).next((()=>{this.ws=n}))}ee(t){}containsKey(t,e){const n=new Js(e,0),r=this.ws.firstAfterOrEqual(n);return vr.resolve(e.isEqual(r&&r.key))}performConsistencyCheck(t){return this.An.length,vr.resolve()}ps(t,e){return this.gs(t)}gs(t){return 0===this.An.length?0:t-this.An[0].batchId}_s(t){const e=this.gs(t);return e<0||e>=this.An.length?null:this.An[e]}}class Zs{constructor(t,e){this.Jt=t,this.Ts=e,this.docs=new ze(ct.comparator),this.size=0}addEntry(t,e,n){const r=e.key,s=this.docs.get(r),i=s?s.size:0,o=this.Ts(e);return this.docs=this.docs.insert(r,{document:e.clone(),size:o,readTime:n}),this.size+=o-i,this.Jt.addToCollectionParentIndex(t,r.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return vr.resolve(n?n.document.clone():kt.newInvalidDocument(e))}getEntries(t,e){let n=Xe();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.clone():kt.newInvalidDocument(t))})),vr.resolve(n)}getDocumentsMatchingQuery(t,e,n){let r=Xe();const s=new ct(e.path.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:t,value:{document:s,readTime:o}}=i.getNext();if(!e.path.isPrefixOf(t.path))break;o.compareTo(n)<=0||oe(e,s)&&(r=r.insert(s.key,s.clone()))}return vr.resolve(r)}Es(t,e){return vr.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new ti(this)}getSize(t){return vr.resolve(this.size)}}class ti extends Is{constructor(t){super(),this.De=t}applyChanges(t){const e=[];return this.changes.forEach(((n,r)=>{r.document.isValidDocument()?e.push(this.De.addEntry(t,r.document,this.getReadTime(n))):this.De.removeEntry(n)})),vr.waitFor(e)}getFromCache(t,e){return this.De.getEntry(t,e)}getAllFromCache(t,e){return this.De.getEntries(t,e)}}class ei{constructor(t){this.persistence=t,this.Is=new vs((t=>Nt(t)),Dt),this.lastRemoteSnapshotVersion=B.min(),this.highestTargetId=0,this.As=0,this.Rs=new Ys,this.targetCount=0,this.Ps=as.ie()}forEachTarget(t,e){return this.Is.forEach(((t,n)=>e(n))),vr.resolve()}getLastRemoteSnapshotVersion(t){return vr.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return vr.resolve(this.As)}allocateTargetId(t){return this.highestTargetId=this.Ps.next(),vr.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.As&&(this.As=e),vr.resolve()}ce(t){this.Is.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.Ps=new as(e),this.highestTargetId=e),t.sequenceNumber>this.As&&(this.As=t.sequenceNumber)}addTargetData(t,e){return this.ce(e),this.targetCount+=1,vr.resolve()}updateTargetData(t,e){return this.ce(e),vr.resolve()}removeTargetData(t,e){return this.Is.delete(e.target),this.Rs.us(e.targetId),this.targetCount-=1,vr.resolve()}removeTargets(t,e,n){let r=0;const s=[];return this.Is.forEach(((i,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.Is.delete(i),s.push(this.removeMatchingKeysForTargetId(t,o.targetId)),r++)})),vr.waitFor(s).next((()=>r))}getTargetCount(t){return vr.resolve(this.targetCount)}getTargetData(t,e){const n=this.Is.get(e)||null;return vr.resolve(n)}addMatchingKeys(t,e,n){return this.Rs.rs(e,n),vr.resolve()}removeMatchingKeys(t,e,n){this.Rs.cs(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach((e=>{s.push(r.markPotentiallyOrphaned(t,e))})),vr.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.Rs.us(e),vr.resolve()}getMatchingKeysForTargetId(t,e){const n=this.Rs.ls(e);return vr.resolve(n)}containsKey(t,e){return vr.resolve(this.Rs.containsKey(e))}}class ni{constructor(t,e){this.bs={},this.Be=new M(0),this.Ue=!1,this.Ue=!0,this.referenceDelegate=t(this),this.He=new ei(this),this.Jt=new Wr,this.Je=function(t,e){return new Zs(t,e)}(this.Jt,(t=>this.referenceDelegate.vs(t))),this.k=new Mr(e),this.Ye=new Hs(this.k)}start(){return Promise.resolve()}shutdown(){return this.Ue=!1,Promise.resolve()}get started(){return this.Ue}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(){return this.Jt}getMutationQueue(t){let e=this.bs[t.toKey()];return e||(e=new Xs(this.Jt,this.referenceDelegate),this.bs[t.toKey()]=e),e}getTargetCache(){return this.He}getRemoteDocumentCache(){return this.Je}getBundleCache(){return this.Ye}runTransaction(t,e,n){g("MemoryPersistence","Starting transaction:",t);const r=new ri(this.Be.next());return this.referenceDelegate.Vs(),n(r).next((t=>this.referenceDelegate.Ss(r).next((()=>t)))).toPromise().then((t=>(r.raiseOnCommittedEvent(),t)))}Ds(t,e){return vr.or(Object.values(this.bs).map((n=>()=>n.containsKey(t,e))))}}class ri extends wr{constructor(t){super(),this.currentSequenceNumber=t}}class si{constructor(t){this.persistence=t,this.Cs=new Ys,this.Ns=null}static ks(t){return new si(t)}get xs(){if(this.Ns)return this.Ns;throw v()}addReference(t,e,n){return this.Cs.addReference(n,e),this.xs.delete(n.toString()),vr.resolve()}removeReference(t,e,n){return this.Cs.removeReference(n,e),this.xs.add(n.toString()),vr.resolve()}markPotentiallyOrphaned(t,e){return this.xs.add(e.toString()),vr.resolve()}removeTarget(t,e){this.Cs.us(e.targetId).forEach((t=>this.xs.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.xs.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}Vs(){this.Ns=new Set}Ss(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return vr.forEach(this.xs,(n=>{const r=ct.fromPath(n);return this.$s(t,r).next((t=>{t||e.removeEntry(r)}))})).next((()=>(this.Ns=null,e.apply(t))))}updateLimboDocument(t,e){return this.$s(t,e).next((t=>{t?this.xs.delete(e.toString()):this.xs.add(e.toString())}))}vs(t){return 0}$s(t,e){return vr.or([()=>vr.resolve(this.Cs.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ds(t,e)])}}function ii(t,e){return`firestore_clients_${t}_${e}`}function oi(t,e,n){let r=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function ai(t,e){return`firestore_targets_${t}_${e}`}class ci{constructor(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r}static Fs(t,e,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new S(r.error.code,r.error.message))),i?new ci(t,e,r.state,s):(p("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}Os(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class ui{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Fs(t,e){const n=JSON.parse(e);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new S(n.error.code,n.error.message))),s?new ui(t,n.state,r):(p("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}Os(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class hi{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Fs(t,e){const n=JSON.parse(e);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=an();for(let i=0;r&&i<n.activeTargetIds.length;++i)r=at(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new hi(t,s):(p("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class li{constructor(t,e){this.clientId=t,this.onlineState=e}static Fs(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new li(e.clientId,e.onlineState):(p("SharedClientState",`Failed to parse online state: ${t}`),null)}}class di{constructor(){this.activeTargetIds=an()}Ms(t){this.activeTargetIds=this.activeTargetIds.add(t)}Ls(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Os(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class fi{constructor(t,e,n,r,s){this.window=t,this.Oe=e,this.persistenceKey=n,this.Bs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Us=this.qs.bind(this),this.Ks=new ze(P),this.started=!1,this.js=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Qs=ii(this.persistenceKey,this.Bs),this.Ws=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.Ks=this.Ks.insert(this.Bs,new di),this.Gs=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.zs=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.Hs=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.Js=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this.Ys=function(t){return`firestore_bundle_loaded_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.Us)}static bt(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.Tn();for(const n of t){if(n===this.Bs)continue;const t=this.getItem(ii(this.persistenceKey,n));if(t){const e=hi.Fs(n,t);e&&(this.Ks=this.Ks.insert(e.clientId,e))}}this.Xs();const e=this.storage.getItem(this.Js);if(e){const t=this.Zs(e);t&&this.ti(t)}for(const n of this.js)this.qs(n);this.js=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(t){this.setItem(this.Ws,JSON.stringify(t))}getAllActiveQueryTargets(){return this.ei(this.Ks)}isActiveQueryTarget(t){let e=!1;return this.Ks.forEach(((n,r)=>{r.activeTargetIds.has(t)&&(e=!0)})),e}addPendingMutation(t){this.ni(t,"pending")}updateMutationState(t,e,n){this.ni(t,e,n),this.si(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){const n=this.storage.getItem(ai(this.persistenceKey,t));if(n){const r=ui.Fs(t,n);r&&(e=r.state)}}return this.ii.Ms(t),this.Xs(),e}removeLocalQueryTarget(t){this.ii.Ls(t),this.Xs()}isLocalQueryTarget(t){return this.ii.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(ai(this.persistenceKey,t))}updateQueryState(t,e,n){this.ri(t,e,n)}handleUserChange(t,e,n){e.forEach((t=>{this.si(t)})),this.currentUser=t,n.forEach((t=>{this.addPendingMutation(t)}))}setOnlineState(t){this.oi(t)}notifyBundleLoaded(){this.ai()}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Us),this.removeItem(this.Qs),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return g("SharedClientState","READ",t,e),e}setItem(t,e){g("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){g("SharedClientState","REMOVE",t),this.storage.removeItem(t)}qs(t){const e=t;if(e.storageArea===this.storage){if(g("SharedClientState","EVENT",e.key,e.newValue),e.key===this.Qs)return void p("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Oe.enqueueRetryable((async()=>{if(this.started){if(null!==e.key)if(this.Gs.test(e.key)){if(null==e.newValue){const t=this.ci(e.key);return this.ui(t,null)}{const t=this.hi(e.key,e.newValue);if(t)return this.ui(t.clientId,t)}}else if(this.zs.test(e.key)){if(null!==e.newValue){const t=this.li(e.key,e.newValue);if(t)return this.fi(t)}}else if(this.Hs.test(e.key)){if(null!==e.newValue){const t=this.di(e.key,e.newValue);if(t)return this.wi(t)}}else if(e.key===this.Js){if(null!==e.newValue){const t=this.Zs(e.newValue);if(t)return this.ti(t)}}else if(e.key===this.Ws){const t=function(t){let e=M.I;if(null!=t)try{const n=JSON.parse(t);I("number"==typeof n),e=n}catch(t){p("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==M.I&&this.sequenceNumberHandler(t)}else if(e.key===this.Ys)return this.syncEngine._i()}else this.js.push(e)}))}}get ii(){return this.Ks.get(this.Bs)}Xs(){this.setItem(this.Qs,this.ii.Os())}ni(t,e,n){const r=new ci(this.currentUser,t,e,n),s=oi(this.persistenceKey,this.currentUser,t);this.setItem(s,r.Os())}si(t){const e=oi(this.persistenceKey,this.currentUser,t);this.removeItem(e)}oi(t){const e={clientId:this.Bs,onlineState:t};this.storage.setItem(this.Js,JSON.stringify(e))}ri(t,e,n){const r=ai(this.persistenceKey,t),s=new ui(t,e,n);this.setItem(r,s.Os())}ai(){this.setItem(this.Ys,"value-not-used")}ci(t){const e=this.Gs.exec(t);return e?e[1]:null}hi(t,e){const n=this.ci(t);return hi.Fs(n,e)}li(t,e){const n=this.zs.exec(t),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return ci.Fs(new h(s),r,e)}di(t,e){const n=this.Hs.exec(t),r=Number(n[1]);return ui.Fs(r,e)}Zs(t){return li.Fs(t)}async fi(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine.mi(t.batchId,t.state,t.error);g("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}wi(t){return this.syncEngine.gi(t.targetId,t.state,t.error)}ui(t,e){const n=e?this.Ks.insert(t,e):this.Ks.remove(t),r=this.ei(this.Ks),s=this.ei(n),i=[],o=[];return s.forEach((t=>{r.has(t)||i.push(t)})),r.forEach((t=>{s.has(t)||o.push(t)})),this.syncEngine.yi(i,o).then((()=>{this.Ks=n}))}ti(t){this.Ks.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}ei(t){let e=an();return t.forEach(((t,n)=>{e=e.unionWith(n.activeTargetIds)})),e}}class mi{constructor(){this.pi=new di,this.Ti={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.pi.Ms(t),this.Ti[t]||"not-current"}updateQueryState(t,e,n){this.Ti[t]=e}removeLocalQueryTarget(t){this.pi.Ls(t)}isLocalQueryTarget(t){return this.pi.activeTargetIds.has(t)}clearQueryState(t){delete this.Ti[t]}getAllActiveQueryTargets(){return this.pi.activeTargetIds}isActiveQueryTarget(t){return this.pi.activeTargetIds.has(t)}start(){return this.pi=new di,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(){}}class gi{Ei(t){}shutdown(){}}class pi{constructor(){this.Ii=()=>this.Ai(),this.Ri=()=>this.Pi(),this.bi=[],this.vi()}Ei(t){this.bi.push(t)}shutdown(){window.removeEventListener("online",this.Ii),window.removeEventListener("offline",this.Ri)}vi(){window.addEventListener("online",this.Ii),window.addEventListener("offline",this.Ri)}Ai(){g("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.bi)t(0)}Pi(){g("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.bi)t(1)}static bt(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const yi={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class wi{constructor(t){this.Vi=t.Vi,this.Si=t.Si}Di(t){this.Ci=t}Ni(t){this.ki=t}onMessage(t){this.xi=t}close(){this.Si()}send(t){this.Vi(t)}$i(){this.Ci()}Fi(t){this.ki(t)}Oi(t){this.xi(t)}}class vi extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http";this.Mi=e+"://"+t.host,this.Li="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}Bi(t,e,n,r,s){const i=this.Ui(t,e);g("RestConnection","Sending: ",i,n);const o={};return this.qi(o,r,s),this.Ki(t,i,o,n).then((t=>(g("RestConnection","Received: ",t),t)),(e=>{throw y("RestConnection",`${t} failed with error: `,e,"url: ",i,"request:",n),e}))}ji(t,e,n,r,s){return this.Bi(t,e,n,r,s)}qi(t,e,n){t["X-Goog-Api-Client"]="gl-js/ fire/"+l,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach(((e,n)=>t[n]=e)),n&&n.headers.forEach(((e,n)=>t[n]=e))}Ui(t,e){const n=yi[t];return`${this.Mi}/v1/${e}:${n}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams}Ki(t,e,n,r){return new Promise(((s,i)=>{const o=new a.JJ;o.listenOnce(a.tw.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case a.jK.NO_ERROR:const e=o.getResponseJson();g("Connection","XHR received:",JSON.stringify(e)),s(e);break;case a.jK.TIMEOUT:g("Connection",'RPC "'+t+'" timed out'),i(new S(b.DEADLINE_EXCEEDED,"Request time out"));break;case a.jK.HTTP_ERROR:const n=o.getStatus();if(g("Connection",'RPC "'+t+'" failed with status:',n,"response text:",o.getResponseText()),n>0){const t=o.getResponseJson().error;if(t&&t.status&&t.message){const e=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(b).indexOf(e)>=0?e:b.UNKNOWN}(t.status);i(new S(e,t.message))}else i(new S(b.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new S(b.UNAVAILABLE,"Connection failed."));break;default:v()}}finally{g("Connection",'RPC "'+t+'" completed.')}}));const c=JSON.stringify(r);o.send(e,"POST",c,n,15)}))}Qi(t,e,n){const r=[this.Mi,"/","google.firestore.v1.Firestore","/",t,"/channel"],s=(0,a.UE)(),i=(0,a.FJ)(),c={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(c.xmlHttpFactory=new a.zI({})),this.qi(c.initMessageHeaders,e,n),(0,o.uI)()||(0,o.b$)()||(0,o.d)()||(0,o.w1)()||(0,o.Mn)()||(0,o.ru)()||(c.httpHeadersOverwriteParam="$httpHeaders");const u=r.join("");g("Connection","Creating WebChannel: "+u,c);const h=s.createWebChannel(u,c);let l=!1,d=!1;const f=new wi({Vi:t=>{d?g("Connection","Not sending because WebChannel is closed:",t):(l||(g("Connection","Opening WebChannel transport."),h.open(),l=!0),g("Connection","WebChannel sending:",t),h.send(t))},Si:()=>h.close()}),m=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return m(h,a.ii.EventType.OPEN,(()=>{d||g("Connection","WebChannel transport opened.")})),m(h,a.ii.EventType.CLOSE,(()=>{d||(d=!0,g("Connection","WebChannel transport closed"),f.Fi())})),m(h,a.ii.EventType.ERROR,(t=>{d||(d=!0,y("Connection","WebChannel transport errored:",t),f.Fi(new S(b.UNAVAILABLE,"The operation could not be completed")))})),m(h,a.ii.EventType.MESSAGE,(t=>{var e;if(!d){const n=t.data[0];I(!!n);const r=n,s=r.error||(null===(e=r[0])||void 0===e?void 0:e.error);if(s){g("Connection","WebChannel received error:",s);const t=s.status;let e=function(t){const e=Ke[t];if(void 0!==e)return Ge(e)}(t),n=s.message;void 0===e&&(e=b.INTERNAL,n="Unknown error status: "+t+" with message "+s.message),d=!0,f.Fi(new S(e,n)),h.close()}else g("Connection","WebChannel received:",n),f.Oi(n)}})),m(i,a.ju.STAT_EVENT,(t=>{t.stat===a.kN.PROXY?g("Connection","Detected buffering proxy"):t.stat===a.kN.NOPROXY&&g("Connection","Detected no buffering proxy")})),setTimeout((()=>{f.$i()}),0),f}}function Ii(){return"undefined"!=typeof window?window:null}function Ti(){return"undefined"!=typeof document?document:null}function Ei(t){return new vn(t,!0)}class bi{constructor(t,e,n=1e3,r=1.5,s=6e4){this.Oe=t,this.timerId=e,this.Wi=n,this.Gi=r,this.zi=s,this.Hi=0,this.Ji=null,this.Yi=Date.now(),this.reset()}reset(){this.Hi=0}Xi(){this.Hi=this.zi}Zi(t){this.cancel();const e=Math.floor(this.Hi+this.tr()),n=Math.max(0,Date.now()-this.Yi),r=Math.max(0,e-n);r>0&&g("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Hi} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Ji=this.Oe.enqueueAfterDelay(this.timerId,r,(()=>(this.Yi=Date.now(),t()))),this.Hi*=this.Gi,this.Hi<this.Wi&&(this.Hi=this.Wi),this.Hi>this.zi&&(this.Hi=this.zi)}er(){null!==this.Ji&&(this.Ji.skipDelay(),this.Ji=null)}cancel(){null!==this.Ji&&(this.Ji.cancel(),this.Ji=null)}tr(){return(Math.random()-.5)*this.Hi}}class Si{constructor(t,e,n,r,s,i,o,a){this.Oe=t,this.nr=n,this.sr=r,this.ir=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.rr=0,this.ar=null,this.cr=null,this.stream=null,this.ur=new bi(t,e)}hr(){return 1===this.state||5===this.state||this.lr()}lr(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.dr()}async stop(){this.hr()&&await this.close(0)}wr(){this.state=0,this.ur.reset()}_r(){this.lr()&&null===this.ar&&(this.ar=this.Oe.enqueueAfterDelay(this.nr,6e4,(()=>this.mr())))}gr(t){this.yr(),this.stream.send(t)}async mr(){if(this.lr())return this.close(0)}yr(){this.ar&&(this.ar.cancel(),this.ar=null)}pr(){this.cr&&(this.cr.cancel(),this.cr=null)}async close(t,e){this.yr(),this.pr(),this.ur.cancel(),this.rr++,4!==t?this.ur.reset():e&&e.code===b.RESOURCE_EXHAUSTED?(p(e.toString()),p("Using maximum backoff delay to prevent overloading the backend."),this.ur.Xi()):e&&e.code===b.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Tr(),this.stream.close(),this.stream=null),this.state=t,await this.listener.Ni(e)}Tr(){}auth(){this.state=1;const t=this.Er(this.rr),e=this.rr;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([t,n])=>{this.rr===e&&this.Ir(t,n)}),(e=>{t((()=>{const t=new S(b.UNKNOWN,"Fetching auth token failed: "+e.message);return this.Ar(t)}))}))}Ir(t,e){const n=this.Er(this.rr);this.stream=this.Rr(t,e),this.stream.Di((()=>{n((()=>(this.state=2,this.cr=this.Oe.enqueueAfterDelay(this.sr,1e4,(()=>(this.lr()&&(this.state=3),Promise.resolve()))),this.listener.Di())))})),this.stream.Ni((t=>{n((()=>this.Ar(t)))})),this.stream.onMessage((t=>{n((()=>this.onMessage(t)))}))}dr(){this.state=5,this.ur.Zi((async()=>{this.state=0,this.start()}))}Ar(t){return g("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}Er(t){return e=>{this.Oe.enqueueAndForget((()=>this.rr===t?e():(g("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class ki extends Si{constructor(t,e,n,r,s,i){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,r,i),this.k=s}Rr(t,e){return this.ir.Qi("Listen",t,e)}onMessage(t){this.ur.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const r=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:v()}(e.targetChange.targetChangeType||"NO_CHANGE"),s=e.targetChange.targetIds||[],i=function(t,e){return t.C?(I(void 0===e||"string"==typeof e),J.fromBase64String(e||"")):(I(void 0===e||e instanceof Uint8Array),J.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(t){const e=void 0===t.code?b.UNKNOWN:Ge(t.code);return new S(e,t.message||"")}(o);n=new dn(r,s,i,a||null)}else if("documentChange"in e){e.documentChange;const r=e.documentChange;r.document,r.document.name,r.document.updateTime;const s=An(t,r.document.name),i=bn(r.document.updateTime),o=new bt({mapValue:{fields:r.document.fields}}),a=kt.newFoundDocument(s,i,o),c=r.targetIds||[],u=r.removedTargetIds||[];n=new hn(c,u,a.key,a)}else if("documentDelete"in e){e.documentDelete;const r=e.documentDelete;r.document;const s=An(t,r.document),i=r.readTime?bn(r.readTime):B.min(),o=kt.newNoDocument(s,i),a=r.removedTargetIds||[];n=new hn([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;const r=e.documentRemove;r.document;const s=An(t,r.document),i=r.removedTargetIds||[];n=new hn([],i,s,null)}else{if(!("filter"in e))return v();{e.filter;const t=e.filter;t.targetId;const r=t.count||0,s=new Be(r),i=t.targetId;n=new ln(i,s)}}return n}(this.k,t),n=function(t){if(!("targetChange"in t))return B.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?B.min():e.readTime?bn(e.readTime):B.min()}(t);return this.listener.Pr(e,n)}br(t){const e={};e.database=Cn(this.k),e.addTarget=function(t,e){let n;const r=e.target;return n=Ct(r)?{documents:On(t,r)}:{query:Pn(t,r)},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0?n.resumeToken=Tn(t,e.resumeToken):e.snapshotVersion.compareTo(B.min())>0&&(n.readTime=In(t,e.snapshotVersion.toTimestamp())),n}(this.k,t);const n=function(t,e){const n=function(t,e){switch(e){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return v()}}(0,e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.k,t);n&&(e.labels=n),this.gr(e)}vr(t){const e={};e.database=Cn(this.k),e.removeTarget=t,this.gr(e)}}class _i extends Si{constructor(t,e,n,r,s,i){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,r,i),this.k=s,this.Vr=!1}get Sr(){return this.Vr}start(){this.Vr=!1,this.lastStreamToken=void 0,super.start()}Tr(){this.Vr&&this.Dr([])}Rr(t,e){return this.ir.Qi("Write",t,e)}onMessage(t){if(I(!!t.streamToken),this.lastStreamToken=t.streamToken,this.Vr){this.ur.reset();const e=function(t,e){return t&&t.length>0?(I(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?bn(t.updateTime):bn(e);return n.isEqual(B.min())&&(n=bn(e)),new ke(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=bn(t.commitTime);return this.listener.Cr(n,e)}return I(!t.writeResults||0===t.writeResults.length),this.Vr=!0,this.listener.Nr()}kr(){const t={};t.database=Cn(this.k),this.gr(t)}Dr(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>Mn(this.k,t)))};this.gr(e)}}class Ai extends class{}{constructor(t,e,n,r){super(),this.authCredentials=t,this.appCheckCredentials=e,this.ir=n,this.k=r,this.$r=!1}Fr(){if(this.$r)throw new S(b.FAILED_PRECONDITION,"The client has already been terminated.")}Bi(t,e,n){return this.Fr(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,s])=>this.ir.Bi(t,e,n,r,s))).catch((t=>{throw"FirebaseError"===t.name?(t.code===b.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new S(b.UNKNOWN,t.toString())}))}ji(t,e,n){return this.Fr(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,s])=>this.ir.ji(t,e,n,r,s))).catch((t=>{throw"FirebaseError"===t.name?(t.code===b.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new S(b.UNKNOWN,t.toString())}))}terminate(){this.$r=!0}}class Ni{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.Or=0,this.Mr=null,this.Lr=!0}Br(){0===this.Or&&(this.Ur("Unknown"),this.Mr=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.Mr=null,this.qr("Backend didn't respond within 10 seconds."),this.Ur("Offline"),Promise.resolve()))))}Kr(t){"Online"===this.state?this.Ur("Unknown"):(this.Or++,this.Or>=1&&(this.jr(),this.qr(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.Ur("Offline")))}set(t){this.jr(),this.Or=0,"Online"===t&&(this.Lr=!1),this.Ur(t)}Ur(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}qr(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.Lr?(p(e),this.Lr=!1):g("OnlineStateTracker",e)}jr(){null!==this.Mr&&(this.Mr.cancel(),this.Mr=null)}}class Di{constructor(t,e,n,r,s){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.Qr=[],this.Wr=new Map,this.Gr=new Set,this.zr=[],this.Hr=s,this.Hr.Ei((t=>{n.enqueueAndForget((async()=>{Vi(this)&&(g("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=E(t);e.Gr.add(4),await xi(e),e.Jr.set("Unknown"),e.Gr.delete(4),await Ci(e)}(this))}))})),this.Jr=new Ni(n,r)}}async function Ci(t){if(Vi(t))for(const e of t.zr)await e(!0)}async function xi(t){for(const e of t.zr)await e(!1)}function Ri(t,e){const n=E(t);n.Wr.has(e.targetId)||(n.Wr.set(e.targetId,e),Pi(n)?Oi(n):eo(n).lr()&&Mi(n,e))}function Li(t,e){const n=E(t),r=eo(n);n.Wr.delete(e),r.lr()&&Fi(n,e),0===n.Wr.size&&(r.lr()?r._r():Vi(n)&&n.Jr.set("Unknown"))}function Mi(t,e){t.Yr.X(e.targetId),eo(t).br(e)}function Fi(t,e){t.Yr.X(e),eo(t).vr(e)}function Oi(t){t.Yr=new mn({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),Et:e=>t.Wr.get(e)||null}),eo(t).start(),t.Jr.Br()}function Pi(t){return Vi(t)&&!eo(t).hr()&&t.Wr.size>0}function Vi(t){return 0===E(t).Gr.size}function qi(t){t.Yr=void 0}async function Ui(t){t.Wr.forEach(((e,n)=>{Mi(t,e)}))}async function Bi(t,e){qi(t),Pi(t)?(t.Jr.Kr(e),Oi(t)):t.Jr.set("Unknown")}async function Ki(t,e,n){if(t.Jr.set("Online"),e instanceof dn&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const r of e.targetIds)t.Wr.has(r)&&(await t.remoteSyncer.rejectListen(r,n),t.Wr.delete(r),t.Yr.removeTarget(r))}(t,e)}catch(n){g("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await $i(t,n)}else if(e instanceof hn?t.Yr.ot(e):e instanceof ln?t.Yr.dt(e):t.Yr.ut(e),!n.isEqual(B.min()))try{const e=await Us(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.Yr.gt(e);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=t.Wr.get(r);s&&t.Wr.set(r,s.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach((e=>{const n=t.Wr.get(e);if(!n)return;t.Wr.set(e,n.withResumeToken(J.EMPTY_BYTE_STRING,n.snapshotVersion)),Fi(t,e);const r=new Lr(n.target,e,1,n.sequenceNumber);Mi(t,r)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){g("RemoteStore","Failed to raise snapshot:",e),await $i(t,e)}}async function $i(t,e,n){if(!Sr(e))throw e;t.Gr.add(1),await xi(t),t.Jr.set("Offline"),n||(n=()=>Us(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{g("RemoteStore","Retrying IndexedDB access"),await n(),t.Gr.delete(1),await Ci(t)}))}function ji(t,e){return e().catch((n=>$i(t,n,e)))}async function Gi(t){const e=E(t),n=no(e);let r=e.Qr.length>0?e.Qr[e.Qr.length-1].batchId:-1;for(;zi(e);)try{const t=await Ks(e.localStore,r);if(null===t){0===e.Qr.length&&n._r();break}r=t.batchId,Qi(e,t)}catch(t){await $i(e,t)}Wi(e)&&Hi(e)}function zi(t){return Vi(t)&&t.Qr.length<10}function Qi(t,e){t.Qr.push(e);const n=no(t);n.lr()&&n.Sr&&n.Dr(e.mutations)}function Wi(t){return Vi(t)&&!no(t).hr()&&t.Qr.length>0}function Hi(t){no(t).start()}async function Yi(t){no(t).kr()}async function Ji(t){const e=no(t);for(const n of t.Qr)e.Dr(n.mutations)}async function Xi(t,e,n){const r=t.Qr.shift(),s=Rr.from(r,e,n);await ji(t,(()=>t.remoteSyncer.applySuccessfulWrite(s))),await Gi(t)}async function Zi(t,e){e&&no(t).Sr&&await async function(t,e){if(je(n=e.code)&&n!==b.ABORTED){const n=t.Qr.shift();no(t).wr(),await ji(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await Gi(t)}var n}(t,e),Wi(t)&&Hi(t)}async function to(t,e){const n=E(t);e?(n.Gr.delete(2),await Ci(n)):e||(n.Gr.add(2),await xi(n),n.Jr.set("Unknown"))}function eo(t){return t.Xr||(t.Xr=function(t,e,n){const r=E(t);return r.Fr(),new ki(e,r.ir,r.authCredentials,r.appCheckCredentials,r.k,n)}(t.datastore,t.asyncQueue,{Di:Ui.bind(null,t),Ni:Bi.bind(null,t),Pr:Ki.bind(null,t)}),t.zr.push((async e=>{e?(t.Xr.wr(),Pi(t)?Oi(t):t.Jr.set("Unknown")):(await t.Xr.stop(),qi(t))}))),t.Xr}function no(t){return t.Zr||(t.Zr=function(t,e,n){const r=E(t);return r.Fr(),new _i(e,r.ir,r.authCredentials,r.appCheckCredentials,r.k,n)}(t.datastore,t.asyncQueue,{Di:Yi.bind(null,t),Ni:Zi.bind(null,t),Nr:Ji.bind(null,t),Cr:Xi.bind(null,t)}),t.zr.push((async e=>{e?(t.Zr.wr(),await Gi(t)):(await t.Zr.stop(),t.Qr.length>0&&(g("RemoteStore",`Stopping write stream with ${t.Qr.length} pending writes`),t.Qr=[]))}))),t.Zr}class ro{constructor(t,e,n,r,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new k,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}static createAndSchedule(t,e,n,r,s){const i=Date.now()+n,o=new ro(t,e,i,r,s);return o.start(n),o}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new S(b.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function so(t,e){if(p("AsyncQueue",`${e}: ${t}`),Sr(t))return new S(b.UNAVAILABLE,`${e}: ${t}`);throw t}class io{constructor(t){this.comparator=t?(e,n)=>t(e,n)||ct.comparator(e.key,n.key):(t,e)=>ct.comparator(t.key,e.key),this.keyedMap=tn(),this.sortedSet=new ze(this.comparator)}static emptySet(t){return new io(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof io))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(!t.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new io;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class oo{constructor(){this.eo=new ze(ct.comparator)}track(t){const e=t.doc.key,n=this.eo.get(e);n?0!==t.type&&3===n.type?this.eo=this.eo.insert(e,t):3===t.type&&1!==n.type?this.eo=this.eo.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.eo=this.eo.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.eo=this.eo.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.eo=this.eo.remove(e):1===t.type&&2===n.type?this.eo=this.eo.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.eo=this.eo.insert(e,{type:2,doc:t.doc}):v():this.eo=this.eo.insert(e,t)}no(){const t=[];return this.eo.inorderTraversal(((e,n)=>{t.push(n)})),t}}class ao{constructor(t,e,n,r,s,i,o,a){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(t,e,n,r){const s=[];return e.forEach((t=>{s.push({type:0,doc:t})})),new ao(t,e,io.emptySet(e),s,n,r,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&re(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let r=0;r<e.length;r++)if(e[r].type!==n[r].type||!e[r].doc.isEqual(n[r].doc))return!1;return!0}}class co{constructor(){this.so=void 0,this.listeners=[]}}class uo{constructor(){this.queries=new vs((t=>se(t)),re),this.onlineState="Unknown",this.io=new Set}}async function ho(t,e){const n=E(t),r=e.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new co),s)try{i.so=await n.onListen(r)}catch(t){const n=so(t,`Initialization of query '${ie(e.query)}' failed`);return void e.onError(n)}n.queries.set(r,i),i.listeners.push(e),e.ro(n.onlineState),i.so&&e.oo(i.so)&&go(n)}async function lo(t,e){const n=E(t),r=e.query;let s=!1;const i=n.queries.get(r);if(i){const t=i.listeners.indexOf(e);t>=0&&(i.listeners.splice(t,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function fo(t,e){const n=E(t);let r=!1;for(const s of e){const t=s.query,e=n.queries.get(t);if(e){for(const t of e.listeners)t.oo(s)&&(r=!0);e.so=s}}r&&go(n)}function mo(t,e,n){const r=E(t),s=r.queries.get(e);if(s)for(const i of s.listeners)i.onError(n);r.queries.delete(e)}function go(t){t.io.forEach((t=>{t.next()}))}class po{constructor(t,e,n){this.query=t,this.ao=e,this.co=!1,this.uo=null,this.onlineState="Unknown",this.options=n||{}}oo(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new ao(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}let e=!1;return this.co?this.ho(t)&&(this.ao.next(t),e=!0):this.lo(t,this.onlineState)&&(this.fo(t),e=!0),this.uo=t,e}onError(t){this.ao.error(t)}ro(t){this.onlineState=t;let e=!1;return this.uo&&!this.co&&this.lo(this.uo,t)&&(this.fo(this.uo),e=!0),e}lo(t,e){if(!t.fromCache)return!0;const n="Offline"!==e;return(!this.options.wo||!n)&&(!t.docs.isEmpty()||"Offline"===e)}ho(t){if(t.docChanges.length>0)return!0;const e=this.uo&&this.uo.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}fo(t){t=ao.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.co=!0,this.ao.next(t)}}class yo{constructor(t,e){this.payload=t,this.byteLength=e}_o(){return"metadata"in this.payload}}class wo{constructor(t){this.k=t}Hn(t){return An(this.k,t)}Jn(t){return t.metadata.exists?Ln(this.k,t.document,!1):kt.newNoDocument(this.Hn(t.metadata.name),this.Yn(t.metadata.readTime))}Yn(t){return bn(t)}}class vo{constructor(t,e,n){this.mo=t,this.localStore=e,this.k=n,this.queries=[],this.documents=[],this.progress=Io(t)}yo(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;return t.payload.namedQuery?this.queries.push(t.payload.namedQuery):t.payload.documentMetadata?(this.documents.push({metadata:t.payload.documentMetadata}),t.payload.documentMetadata.exists||++e):t.payload.document&&(this.documents[this.documents.length-1].document=t.payload.document,++e),e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}po(t){const e=new Map,n=new wo(this.k);for(const r of t)if(r.metadata.queries){const t=n.Hn(r.metadata.name);for(const n of r.metadata.queries){const r=(e.get(n)||sn()).add(t);e.set(n,r)}}return e}async complete(){const t=await async function(t,e,n,r){const s=E(t);let i=sn(),o=Xe(),a=nn();for(const h of n){const t=e.Hn(h.metadata.name);h.document&&(i=i.add(t)),o=o.insert(t,e.Jn(h)),a=a.insert(t,e.Yn(h.metadata.readTime))}const c=s.Qn.newChangeBuffer({trackRemovals:!0}),u=await $s(s,function(t){return ee(Wt(z.fromString(`__bundle__/docs/${t}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(t=>Bs(t,c,o,B.min(),a).next((e=>(c.apply(t),e))).next((e=>s.He.removeMatchingKeysForTargetId(t,u.targetId).next((()=>s.He.addMatchingKeys(t,i,u.targetId))).next((()=>s.Wn.Vn(t,e))).next((()=>e))))))}(this.localStore,new wo(this.k),this.documents,this.mo.id),e=this.po(this.documents);for(const n of this.queries)await Ws(this.localStore,n,e.get(n.name));return this.progress.taskState="Success",new Ls(Object.assign({},this.progress),t)}}function Io(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class To{constructor(t){this.key=t}}class Eo{constructor(t){this.key=t}}class bo{constructor(t,e){this.query=t,this.To=e,this.Eo=null,this.current=!1,this.Io=sn(),this.mutatedKeys=sn(),this.Ao=ae(t),this.Ro=new io(this.Ao)}get Po(){return this.To}bo(t,e){const n=e?e.vo:new oo,r=e?e.Ro:this.Ro;let s=e?e.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a=Ht(this.query)&&r.size===this.query.limit?r.last():null,c=Yt(this.query)&&r.size===this.query.limit?r.first():null;if(t.inorderTraversal(((t,e)=>{const u=r.get(t),h=oe(this.query,e)?e:null,l=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations);let f=!1;u&&h?u.data.isEqual(h.data)?l!==d&&(n.track({type:3,doc:h}),f=!0):this.Vo(u,h)||(n.track({type:2,doc:h}),f=!0,(a&&this.Ao(h,a)>0||c&&this.Ao(h,c)<0)&&(o=!0)):!u&&h?(n.track({type:0,doc:h}),f=!0):u&&!h&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0)),f&&(h?(i=i.add(h),s=d?s.add(t):s.delete(t)):(i=i.delete(t),s=s.delete(t)))})),Ht(this.query)||Yt(this.query))for(;i.size>this.query.limit;){const t=Ht(this.query)?i.last():i.first();i=i.delete(t.key),s=s.delete(t.key),n.track({type:1,doc:t})}return{Ro:i,vo:n,Bn:o,mutatedKeys:s}}Vo(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){const r=this.Ro;this.Ro=t.Ro,this.mutatedKeys=t.mutatedKeys;const s=t.vo.no();s.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return v()}};return n(t)-n(e)}(t.type,e.type)||this.Ao(t.doc,e.doc))),this.So(n);const i=e?this.Do():[],o=0===this.Io.size&&this.current?1:0,a=o!==this.Eo;return this.Eo=o,0!==s.length||a?{snapshot:new ao(this.query,t.Ro,r,s,t.mutatedKeys,0===o,a,!1),Co:i}:{Co:i}}ro(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({Ro:this.Ro,vo:new oo,mutatedKeys:this.mutatedKeys,Bn:!1},!1)):{Co:[]}}No(t){return!this.To.has(t)&&!!this.Ro.has(t)&&!this.Ro.get(t).hasLocalMutations}So(t){t&&(t.addedDocuments.forEach((t=>this.To=this.To.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.To=this.To.delete(t))),this.current=t.current)}Do(){if(!this.current)return[];const t=this.Io;this.Io=sn(),this.Ro.forEach((t=>{this.No(t.key)&&(this.Io=this.Io.add(t.key))}));const e=[];return t.forEach((t=>{this.Io.has(t)||e.push(new Eo(t))})),this.Io.forEach((n=>{t.has(n)||e.push(new To(n))})),e}ko(t){this.To=t.zn,this.Io=sn();const e=this.bo(t.documents);return this.applyChanges(e,!0)}xo(){return ao.fromInitialDocuments(this.query,this.Ro,this.mutatedKeys,0===this.Eo)}}class So{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class ko{constructor(t){this.key=t,this.$o=!1}}class _o{constructor(t,e,n,r,s,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.Fo={},this.Oo=new vs((t=>se(t)),re),this.Mo=new Map,this.Lo=new Set,this.Bo=new ze(ct.comparator),this.Uo=new Map,this.qo=new Ys,this.Ko={},this.jo=new Map,this.Qo=as.re(),this.onlineState="Unknown",this.Wo=void 0}get isPrimaryClient(){return!0===this.Wo}}async function Ao(t,e){const n=Zo(t);let r,s;const i=n.Oo.get(e);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.xo();else{const t=await $s(n.localStore,ee(e)),i=n.sharedClientState.addLocalQueryTarget(t.targetId);r=t.targetId,s=await No(n,e,r,"current"===i),n.isPrimaryClient&&Ri(n.remoteStore,t)}return s}async function No(t,e,n,r){t.Go=(e,n,r)=>async function(t,e,n,r){let s=e.view.bo(n);s.Bn&&(s=await Gs(t.localStore,e.query,!1).then((({documents:t})=>e.view.bo(t,s))));const i=r&&r.targetChanges.get(e.targetId),o=e.view.applyChanges(s,t.isPrimaryClient,i);return qo(t,e.targetId,o.Co),o.snapshot}(t,e,n,r);const s=await Gs(t.localStore,e,!0),i=new bo(e,s.zn),o=i.bo(s.documents),a=un.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==t.onlineState),c=i.applyChanges(o,t.isPrimaryClient,a);qo(t,n,c.Co);const u=new So(e,n,i);return t.Oo.set(e,u),t.Mo.has(n)?t.Mo.get(n).push(e):t.Mo.set(n,[e]),c.snapshot}async function Do(t,e){const n=E(t),r=n.Oo.get(e),s=n.Mo.get(r.targetId);if(s.length>1)return n.Mo.set(r.targetId,s.filter((t=>!re(t,e)))),void n.Oo.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await js(n.localStore,r.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(r.targetId),Li(n.remoteStore,r.targetId),Po(n,r.targetId)})).catch(ds)):(Po(n,r.targetId),await js(n.localStore,r.targetId,!0))}async function Co(t,e){const n=E(t);try{const t=await function(t,e){const n=E(t),r=e.snapshotVersion;let s=n.qn;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const i=n.Qn.newChangeBuffer({trackRemovals:!0});s=n.qn;const o=[];e.targetChanges.forEach(((e,i)=>{const a=s.get(i);if(!a)return;o.push(n.He.removeMatchingKeys(t,e.removedDocuments,i).next((()=>n.He.addMatchingKeys(t,e.addedDocuments,i))));const c=e.resumeToken;if(c.approximateByteSize()>0){const u=a.withResumeToken(c,r).withSequenceNumber(t.currentSequenceNumber);s=s.insert(i,u),function(t,e,n){return I(e.resumeToken.approximateByteSize()>0),0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(a,u,e)&&o.push(n.He.updateTargetData(t,u))}}));let a=Xe();if(e.documentUpdates.forEach(((r,s)=>{e.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,r))})),o.push(Bs(t,i,e.documentUpdates,r,void 0).next((t=>{a=t}))),!r.isEqual(B.min())){const e=n.He.getLastRemoteSnapshotVersion(t).next((e=>n.He.setTargetsMetadata(t,t.currentSequenceNumber,r)));o.push(e)}return vr.waitFor(o).next((()=>i.apply(t))).next((()=>n.Wn.Vn(t,a))).next((()=>a))})).then((t=>(n.qn=s,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const r=n.Uo.get(e);r&&(I(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?r.$o=!0:t.modifiedDocuments.size>0?I(r.$o):t.removedDocuments.size>0&&(I(r.$o),r.$o=!1))})),await Ko(n,t,e)}catch(t){await ds(t)}}function xo(t,e,n){const r=E(t);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const t=[];r.Oo.forEach(((n,r)=>{const s=r.view.ro(e);s.snapshot&&t.push(s.snapshot)})),function(t,e){const n=E(t);n.onlineState=e;let r=!1;n.queries.forEach(((t,n)=>{for(const s of n.listeners)s.ro(e)&&(r=!0)})),r&&go(n)}(r.eventManager,e),t.length&&r.Fo.Pr(t),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}async function Ro(t,e,n){const r=E(t);r.sharedClientState.updateQueryState(e,"rejected",n);const s=r.Uo.get(e),i=s&&s.key;if(i){let t=new ze(ct.comparator);t=t.insert(i,kt.newNoDocument(i,B.min()));const n=sn().add(i),s=new cn(B.min(),new Map,new He(P),t,n);await Co(r,s),r.Bo=r.Bo.remove(i),r.Uo.delete(e),Bo(r)}else await js(r.localStore,e,!1).then((()=>Po(r,e,n))).catch(ds)}async function Lo(t,e){const n=E(t),r=e.batch.batchId;try{const t=await function(t,e){const n=E(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const r=e.batch.keys(),s=n.Qn.newChangeBuffer({trackRemovals:!0});return function(t,e,n,r){const s=n.batch,i=s.keys();let o=vr.resolve();return i.forEach((t=>{o=o.next((()=>r.getEntry(e,t))).next((e=>{const i=n.docVersions.get(t);I(null!==i),e.version.compareTo(i)<0&&(s.applyToRemoteDocument(e,n),e.isValidDocument()&&r.addEntry(e,n.commitVersion))}))})),o.next((()=>t.An.removeMutationBatch(e,s)))}(n,t,e,s).next((()=>s.apply(t))).next((()=>n.An.performConsistencyCheck(t))).next((()=>n.Wn.vn(t,r)))}))}(n.localStore,e);Oo(n,r,null),Fo(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Ko(n,t)}catch(t){await ds(t)}}async function Mo(t,e,n){const r=E(t);try{const t=await function(t,e){const n=E(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let r;return n.An.lookupMutationBatch(t,e).next((e=>(I(null!==e),r=e.keys(),n.An.removeMutationBatch(t,e)))).next((()=>n.An.performConsistencyCheck(t))).next((()=>n.Wn.vn(t,r)))}))}(r.localStore,e);Oo(r,e,n),Fo(r,e),r.sharedClientState.updateMutationState(e,"rejected",n),await Ko(r,t)}catch(n){await ds(n)}}function Fo(t,e){(t.jo.get(e)||[]).forEach((t=>{t.resolve()})),t.jo.delete(e)}function Oo(t,e,n){const r=E(t);let s=r.Ko[r.currentUser.toKey()];if(s){const t=s.get(e);t&&(n?t.reject(n):t.resolve(),s=s.remove(e)),r.Ko[r.currentUser.toKey()]=s}}function Po(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.Mo.get(e))t.Oo.delete(r),n&&t.Fo.zo(r,n);t.Mo.delete(e),t.isPrimaryClient&&t.qo.us(e).forEach((e=>{t.qo.containsKey(e)||Vo(t,e)}))}function Vo(t,e){t.Lo.delete(e.path.canonicalString());const n=t.Bo.get(e);null!==n&&(Li(t.remoteStore,n),t.Bo=t.Bo.remove(e),t.Uo.delete(n),Bo(t))}function qo(t,e,n){for(const r of n)r instanceof To?(t.qo.addReference(r.key,e),Uo(t,r)):r instanceof Eo?(g("SyncEngine","Document no longer in limbo: "+r.key),t.qo.removeReference(r.key,e),t.qo.containsKey(r.key)||Vo(t,r.key)):v()}function Uo(t,e){const n=e.key,r=n.path.canonicalString();t.Bo.get(n)||t.Lo.has(r)||(g("SyncEngine","New document in limbo: "+n),t.Lo.add(r),Bo(t))}function Bo(t){for(;t.Lo.size>0&&t.Bo.size<t.maxConcurrentLimboResolutions;){const e=t.Lo.values().next().value;t.Lo.delete(e);const n=new ct(z.fromString(e)),r=t.Qo.next();t.Uo.set(r,new ko(n)),t.Bo=t.Bo.insert(n,r),Ri(t.remoteStore,new Lr(ee(Wt(n.path)),r,2,M.I))}}async function Ko(t,e,n){const r=E(t),s=[],i=[],o=[];r.Oo.isEmpty()||(r.Oo.forEach(((t,a)=>{o.push(r.Go(a,e,n).then((t=>{if(t){r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,t.fromCache?"not-current":"current"),s.push(t);const e=Fs.$n(a.targetId,t);i.push(e)}})))})),await Promise.all(o),r.Fo.Pr(s),await async function(t,e){const n=E(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>vr.forEach(e,(e=>vr.forEach(e.kn,(r=>n.persistence.referenceDelegate.addReference(t,e.targetId,r))).next((()=>vr.forEach(e.xn,(r=>n.persistence.referenceDelegate.removeReference(t,e.targetId,r)))))))))}catch(t){if(!Sr(t))throw t;g("LocalStore","Failed to update sequence numbers: "+t)}for(const r of e){const t=r.targetId;if(!r.fromCache){const e=n.qn.get(t),r=e.snapshotVersion,s=e.withLastLimboFreeSnapshotVersion(r);n.qn=n.qn.insert(t,s)}}}(r.localStore,i))}async function $o(t,e){const n=E(t);if(!n.currentUser.isEqual(e)){g("SyncEngine","User change. New user:",e.toKey());const t=await qs(n.localStore,e);n.currentUser=e,function(t,e){t.jo.forEach((t=>{t.forEach((t=>{t.reject(new S(b.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),t.jo.clear()}(n),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await Ko(n,t.Gn)}}function jo(t,e){const n=E(t),r=n.Uo.get(e);if(r&&r.$o)return sn().add(r.key);{let t=sn();const r=n.Mo.get(e);if(!r)return t;for(const e of r){const r=n.Oo.get(e);t=t.unionWith(r.view.Po)}return t}}async function Go(t,e){const n=E(t),r=await Gs(n.localStore,e.query,!0),s=e.view.ko(r);return n.isPrimaryClient&&qo(n,e.targetId,s.Co),s}async function zo(t){const e=E(t);return Qs(e.localStore).then((t=>Ko(e,t)))}async function Qo(t,e,n,r){const s=E(t),i=await function(t,e){const n=E(t),r=E(n.An);return n.persistence.runTransaction("Lookup mutation documents","readonly",(t=>r.Zt(t,e).next((e=>e?n.Wn.vn(t,e):vr.resolve(null)))))}(s.localStore,e);null!==i?("pending"===n?await Gi(s.remoteStore):"acknowledged"===n||"rejected"===n?(Oo(s,e,r||null),Fo(s,e),function(t,e){E(E(t).An).ee(e)}(s.localStore,e)):v(),await Ko(s,i)):g("SyncEngine","Cannot apply mutation batch with id: "+e)}async function Wo(t,e,n){const r=E(t),s=[],i=[];for(const o of e){let t;const e=r.Mo.get(o);if(e&&0!==e.length){t=await $s(r.localStore,ee(e[0]));for(const t of e){const e=r.Oo.get(t),n=await Go(r,e);n.snapshot&&i.push(n.snapshot)}}else{const e=await zs(r.localStore,o);t=await $s(r.localStore,e),await No(r,Ho(e),o,!1)}s.push(t)}return r.Fo.Pr(i),s}function Ho(t){return Qt(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function Yo(t){const e=E(t);return E(E(e.localStore).persistence).Tn()}async function Jo(t,e,n,r){const s=E(t);if(s.Wo)g("SyncEngine","Ignoring unexpected query state notification.");else if(s.Mo.has(e))switch(n){case"current":case"not-current":{const t=await Qs(s.localStore),r=cn.createSynthesizedRemoteEventForCurrentChange(e,"current"===n);await Ko(s,t,r);break}case"rejected":await js(s.localStore,e,!0),Po(s,e,r);break;default:v()}}async function Xo(t,e,n){const r=Zo(t);if(r.Wo){for(const t of e){if(r.Mo.has(t)){g("SyncEngine","Adding an already active target "+t);continue}const e=await zs(r.localStore,t),n=await $s(r.localStore,e);await No(r,Ho(e),n.targetId,!1),Ri(r.remoteStore,n)}for(const t of n)r.Mo.has(t)&&await js(r.localStore,t,!1).then((()=>{Li(r.remoteStore,t),Po(r,t)})).catch(ds)}}function Zo(t){const e=E(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=Co.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=jo.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=Ro.bind(null,e),e.Fo.Pr=fo.bind(null,e.eventManager),e.Fo.zo=mo.bind(null,e.eventManager),e}function ta(t){const e=E(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=Lo.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=Mo.bind(null,e),e}class ea{constructor(){this.synchronizeTabs=!1}async initialize(t){this.k=Ei(t.databaseInfo.databaseId),this.sharedClientState=this.Jo(t),this.persistence=this.Yo(t),await this.persistence.start(),this.gcScheduler=this.Xo(t),this.localStore=this.Zo(t)}Xo(t){return null}Zo(t){return Vs(this.persistence,new Os,t.initialUser,this.k)}Yo(t){return new ni(si.ks,this.k)}Jo(t){return new mi}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class na extends ea{constructor(t,e,n){super(),this.ta=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await async function(t){const e=E(t);return e.persistence.runTransaction("Synchronize last document change read time","readonly",(t=>function(t){const e=Ss(t);let n=B.min();return e.jt({index:ar.readTimeIndex,reverse:!0},((t,e,r)=>{e.readTime&&(n=Vr(e.readTime)),r.done()})).next((()=>n))}(t))).then((t=>{e.jn=t}))}(this.localStore),await this.ta.initialize(this,t),await ta(this.ta.syncEngine),await Gi(this.ta.remoteStore),await this.persistence.sn((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(this.localStore),Promise.resolve())))}Zo(t){return Vs(this.persistence,new Os,t.initialUser,this.k)}Xo(t){const e=this.persistence.referenceDelegate.garbageCollector;return new gs(e,t.asyncQueue)}Yo(t){const e=Rs(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Zr.withCacheSize(this.cacheSizeBytes):Zr.DEFAULT;return new Ds(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Ii(),Ti(),this.k,this.sharedClientState,!!this.forceOwnership)}Jo(t){return new mi}}class ra extends na{constructor(t,e){super(t,e,!1),this.ta=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.ta.syncEngine;this.sharedClientState instanceof fi&&(this.sharedClientState.syncEngine={mi:Qo.bind(null,e),gi:Jo.bind(null,e),yi:Xo.bind(null,e),Tn:Yo.bind(null,e),_i:zo.bind(null,e)},await this.sharedClientState.start()),await this.persistence.sn((async t=>{await async function(t,e){const n=E(t);if(Zo(n),ta(n),!0===e&&!0!==n.Wo){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await Wo(n,t.toArray());n.Wo=!0,await to(n.remoteStore,!0);for(const r of e)Ri(n.remoteStore,r)}else if(!1===e&&!1!==n.Wo){const t=[];let e=Promise.resolve();n.Mo.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?t.push(s):e=e.then((()=>(Po(n,s),js(n.localStore,s,!0)))),Li(n.remoteStore,s)})),await e,await Wo(n,t),function(t){const e=E(t);e.Uo.forEach(((t,n)=>{Li(e.remoteStore,n)})),e.qo.hs(),e.Uo=new Map,e.Bo=new ze(ct.comparator)}(n),n.Wo=!1,await to(n.remoteStore,!1)}}(this.ta.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):t||this.gcScheduler.stop())}))}Jo(t){const e=Ii();if(!fi.bt(e))throw new S(b.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=Rs(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new fi(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class sa{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>xo(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=$o.bind(null,this.syncEngine),await to(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new uo}createDatastore(t){const e=Ei(t.databaseInfo.databaseId),n=(r=t.databaseInfo,new vi(r));var r;return function(t,e,n,r){return new Ai(t,e,n,r)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return e=this.localStore,n=this.datastore,r=t.asyncQueue,s=t=>xo(this.syncEngine,t,0),i=pi.bt()?new pi:new gi,new Di(e,n,r,s,i);var e,n,r,s,i}createSyncEngine(t,e){return function(t,e,n,r,s,i,o){const a=new _o(t,e,n,r,s,i);return o&&(a.Wo=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=E(t);g("RemoteStore","RemoteStore shutting down."),e.Gr.add(5),await xi(e),e.Hr.shutdown(),e.Jr.set("Unknown")}(this.remoteStore)}}function ia(t,e=10240){let n=0;return{async read(){if(n<t.byteLength){const r={value:t.slice(n,n+e),done:!1};return n+=e,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class oa{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.ea(this.observer.next,t)}error(t){this.observer.error?this.ea(this.observer.error,t):console.error("Uncaught Error in snapshot listener:",t)}na(){this.muted=!0}ea(t,e){this.muted||setTimeout((()=>{this.muted||t(e)}),0)}}class aa{constructor(t,e){this.sa=t,this.k=e,this.metadata=new k,this.buffer=new Uint8Array,this.ia=new TextDecoder("utf-8"),this.ra().then((t=>{t&&t._o()?this.metadata.resolve(t.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.payload)}`))}),(t=>this.metadata.reject(t)))}close(){return this.sa.cancel()}async getMetadata(){return this.metadata.promise}async Ho(){return await this.getMetadata(),this.ra()}async ra(){const t=await this.oa();if(null===t)return null;const e=this.ia.decode(t),n=Number(e);isNaN(n)&&this.aa(`length string (${e}) is not valid number`);const r=await this.ca(n);return new yo(JSON.parse(r),t.length+n)}ua(){return this.buffer.findIndex((t=>t==="{".charCodeAt(0)))}async oa(){for(;this.ua()<0&&!(await this.ha()););if(0===this.buffer.length)return null;const t=this.ua();t<0&&this.aa("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async ca(t){for(;this.buffer.length<t;)await this.ha()&&this.aa("Reached the end of bundle when more is expected.");const e=this.ia.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}aa(t){throw this.sa.cancel(),new Error(`Invalid bundle format: ${t}`)}async ha(){const t=await this.sa.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class ca{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new S(b.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const e=await async function(t,e){const n=E(t),r=Cn(n.k)+"/documents",s={documents:e.map((t=>_n(n.k,t)))},i=await n.ji("BatchGetDocuments",r,s),o=new Map;i.forEach((t=>{const e=function(t,e){return"found"in e?function(t,e){I(!!e.found),e.found.name,e.found.updateTime;const n=An(t,e.found.name),r=bn(e.found.updateTime),s=new bt({mapValue:{fields:e.found.fields}});return kt.newFoundDocument(n,r,s)}(t,e):"missing"in e?function(t,e){I(!!e.missing),I(!!e.readTime);const n=An(t,e.missing),r=bn(e.readTime);return kt.newNoDocument(n,r)}(t,e):v()}(n.k,t);o.set(e.key.toString(),e)}));const a=[];return e.forEach((t=>{const e=o.get(t.toString());I(!!e),a.push(e)})),a}(this.datastore,t);return e.forEach((t=>this.recordVersion(t))),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new qe(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach((e=>{t.delete(e.key.toString())})),t.forEach(((t,e)=>{const n=ct.fromPath(e);this.mutations.push(new Ue(n,this.precondition(n)))})),await async function(t,e){const n=E(t),r=Cn(n.k)+"/documents",s={writes:e.map((t=>Mn(n.k,t)))};await n.Bi("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw v();e=B.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new S(b.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?_e.updateTime(e):_e.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(B.min()))throw new S(b.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return _e.updateTime(e)}return _e.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class ua{constructor(t,e,n,r){this.asyncQueue=t,this.datastore=e,this.updateFunction=n,this.deferred=r,this.la=5,this.ur=new bi(this.asyncQueue,"transaction_retry")}run(){this.la-=1,this.fa()}fa(){this.ur.Zi((async()=>{const t=new ca(this.datastore),e=this.da(t);e&&e.then((e=>{this.asyncQueue.enqueueAndForget((()=>t.commit().then((()=>{this.deferred.resolve(e)})).catch((t=>{this.wa(t)}))))})).catch((t=>{this.wa(t)}))}))}da(t){try{const e=this.updateFunction(t);return!it(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}wa(t){this.la>0&&this._a(t)?(this.la-=1,this.asyncQueue.enqueueAndForget((()=>(this.fa(),Promise.resolve())))):this.deferred.reject(t)}_a(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||!je(e)}return!1}}class ha{constructor(t,e,n,r){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=r,this.user=h.UNAUTHENTICATED,this.clientId=O.A(),this.authCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async t=>{g("FirestoreClient","Received user=",t.uid),await this.authCredentialListener(t),this.user=t})),this.appCheckCredentials.start(n,(()=>Promise.resolve()))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new S(b.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new k;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const n=so(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function la(t,e){t.asyncQueue.verifyOperationInProgress(),g("FirestoreClient","Initializing OfflineComponentProvider");const n=await t.getConfiguration();await e.initialize(n);let r=n.initialUser;t.setCredentialChangeListener((async t=>{r.isEqual(t)||(await qs(e.localStore,t),r=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t.offlineComponents=e}async function da(t,e){t.asyncQueue.verifyOperationInProgress();const n=await fa(t);g("FirestoreClient","Initializing OnlineComponentProvider");const r=await t.getConfiguration();await e.initialize(n,r),t.setCredentialChangeListener((t=>async function(t,e){const n=E(t);n.asyncQueue.verifyOperationInProgress(),g("RemoteStore","RemoteStore received new credentials");const r=Vi(n);n.Gr.add(3),await xi(n),r&&n.Jr.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.Gr.delete(3),await Ci(n)}(e.remoteStore,t))),t.onlineComponents=e}async function fa(t){return t.offlineComponents||(g("FirestoreClient","Using default OfflineComponentProvider"),await la(t,new ea)),t.offlineComponents}async function ma(t){return t.onlineComponents||(g("FirestoreClient","Using default OnlineComponentProvider"),await da(t,new sa)),t.onlineComponents}function ga(t){return fa(t).then((t=>t.persistence))}function pa(t){return fa(t).then((t=>t.localStore))}function ya(t){return ma(t).then((t=>t.remoteStore))}function wa(t){return ma(t).then((t=>t.syncEngine))}async function va(t){const e=await ma(t),n=e.eventManager;return n.onListen=Ao.bind(null,e.syncEngine),n.onUnlisten=Do.bind(null,e.syncEngine),n}function Ia(t,e,n={}){const r=new k;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,s){const i=new oa({next:i=>{e.enqueueAndForget((()=>lo(t,o)));const a=i.docs.has(n);!a&&i.fromCache?s.reject(new S(b.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&r&&"server"===r.source?s.reject(new S(b.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(i)},error:t=>s.reject(t)}),o=new po(Wt(n.path),i,{includeMetadataChanges:!0,wo:!0});return ho(t,o)}(await va(t),t.asyncQueue,e,n,r))),r.promise}function Ta(t,e,n={}){const r=new k;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,s){const i=new oa({next:n=>{e.enqueueAndForget((()=>lo(t,o))),n.fromCache&&"server"===r.source?s.reject(new S(b.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:t=>s.reject(t)}),o=new po(n,i,{includeMetadataChanges:!0,wo:!0});return ho(t,o)}(await va(t),t.asyncQueue,e,n,r))),r.promise}function Ea(t,e,n,r){const s=function(t,e){let n;return n="string"==typeof t?(new TextEncoder).encode(t):t,function(t,e){return new aa(t,e)}(function(t,e){if(t instanceof Uint8Array)return ia(t,e);if(t instanceof ArrayBuffer)return ia(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),e)}(n,Ei(e));t.asyncQueue.enqueueAndForget((async()=>{!function(t,e,n){const r=E(t);(async function(t,e,n){try{const r=await e.getMetadata();if(await function(t,e){const n=E(t),r=bn(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(t=>n.Ye.getBundleMetadata(t,e.id))).then((t=>!!t&&t.createTime.compareTo(r)>=0))}(t.localStore,r))return await e.close(),void n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(r));n._updateProgress(Io(r));const s=new vo(r,t.localStore,e.k);let i=await e.Ho();for(;i;){const t=await s.yo(i);t&&n._updateProgress(t),i=await e.Ho()}const o=await s.complete();await Ko(t,o.In,void 0),await function(t,e){const n=E(t);return n.persistence.runTransaction("Save bundle","readwrite",(t=>n.Ye.saveBundleMetadata(t,e)))}(t.localStore,r),n._completeWith(o.progress)}catch(t){y("SyncEngine",`Loading bundle failed with ${t}`),n._failWith(t)}})(r,e,n).then((()=>{r.sharedClientState.notifyBundleLoaded()}))}(await wa(t),s,r)}))}class ba{constructor(t,e,n,r,s,i,o,a){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class Sa{constructor(t,e){this.projectId=t,this.database=e||"(default)"}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof Sa&&t.projectId===this.projectId&&t.database===this.database}}const ka=new Map;function _a(t,e,n){if(!n)throw new S(b.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function Aa(t,e,n,r){if(!0===e&&!0===r)throw new S(b.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function Na(t){if(!ct.isDocumentKey(t))throw new S(b.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function Da(t){if(ct.isDocumentKey(t))throw new S(b.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function Ca(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":v()}function xa(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new S(b.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Ca(t);throw new S(b.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function Ra(t,e){if(e<=0)throw new S(b.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class La{constructor(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new S(b.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new S(b.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,Aa("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Ma{constructor(t,e,n){this._authCredentials=e,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new La({}),this._settingsFrozen=!1,t instanceof Sa?this._databaseId=t:(this._app=t,this._databaseId=function(t){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new S(b.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Sa(t.options.projectId)}(t))}get app(){if(!this._app)throw new S(b.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new S(b.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new La(t),void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new A;switch(t.type){case"gapi":const e=t.client;return I(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty)),new x(e,t.sessionIndex||"0",t.iamToken||null);case"provider":return t.client;default:throw new S(b.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=ka.get(t);e&&(g("ComponentProvider","Removing Datastore"),ka.delete(t),e.terminate())}(this),Promise.resolve()}}function Fa(t,e,n,r={}){var s;const i=(t=xa(t,Ma))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==e&&y("Host has been set in both settings() and useEmulator(), emulator host will be used"),t._setSettings(Object.assign(Object.assign({},i),{host:`${e}:${n}`,ssl:!1})),r.mockUserToken){let e,n;if("string"==typeof r.mockUserToken)e=r.mockUserToken,n=h.MOCK_USER;else{e=(0,o.Sg)(r.mockUserToken,null===(s=t._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new S(b.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new h(i)}t._authCredentials=new N(new _(e,n))}}class Oa{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Va(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new Oa(this.firestore,t,this._key)}}class Pa{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new Pa(this.firestore,t,this._query)}}class Va extends Pa{constructor(t,e,n){super(t,e,Wt(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new Oa(this.firestore,null,new ct(t))}withConverter(t){return new Va(this.firestore,t,this._path)}}function qa(t,e,...n){if(t=(0,o.m9)(t),_a("collection","path",e),t instanceof Ma){const r=z.fromString(e,...n);return Da(r),new Va(t,null,r)}{if(!(t instanceof Oa||t instanceof Va))throw new S(b.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=t._path.child(z.fromString(e,...n));return Da(r),new Va(t.firestore,null,r)}}function Ua(t,e){if(t=xa(t,Ma),_a("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new S(b.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Pa(t,null,function(t){return new zt(z.emptyPath(),t)}(e))}function Ba(t,e,...n){if(t=(0,o.m9)(t),1===arguments.length&&(e=O.A()),_a("doc","path",e),t instanceof Ma){const r=z.fromString(e,...n);return Na(r),new Oa(t,null,new ct(r))}{if(!(t instanceof Oa||t instanceof Va))throw new S(b.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=t._path.child(z.fromString(e,...n));return Na(r),new Oa(t.firestore,t instanceof Va?t.converter:null,new ct(r))}}function Ka(t,e){return t=(0,o.m9)(t),e=(0,o.m9)(e),(t instanceof Oa||t instanceof Va)&&(e instanceof Oa||e instanceof Va)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function $a(t,e){return t=(0,o.m9)(t),e=(0,o.m9)(e),t instanceof Pa&&e instanceof Pa&&t.firestore===e.firestore&&re(t._query,e._query)&&t.converter===e.converter}class ja{constructor(){this.ma=Promise.resolve(),this.ga=[],this.ya=!1,this.pa=[],this.Ta=null,this.Ea=!1,this.Ia=!1,this.Aa=[],this.ur=new bi(this,"async_queue_retry"),this.Ra=()=>{const t=Ti();t&&g("AsyncQueue","Visibility state changed to "+t.visibilityState),this.ur.er()};const t=Ti();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Ra)}get isShuttingDown(){return this.ya}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.Pa(),this.ba(t)}enterRestrictedMode(t){if(!this.ya){this.ya=!0,this.Ia=t||!1;const e=Ti();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.Ra)}}enqueue(t){if(this.Pa(),this.ya)return new Promise((()=>{}));const e=new k;return this.ba((()=>this.ya&&this.Ia?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.ga.push(t),this.va())))}async va(){if(0!==this.ga.length){try{await this.ga[0](),this.ga.shift(),this.ur.reset()}catch(t){if(!Sr(t))throw t;g("AsyncQueue","Operation failed with retryable error: "+t)}this.ga.length>0&&this.ur.Zi((()=>this.va()))}}ba(t){const e=this.ma.then((()=>(this.Ea=!0,t().catch((t=>{this.Ta=t,this.Ea=!1;throw p("INTERNAL UNHANDLED ERROR: ",function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t)),t})).then((t=>(this.Ea=!1,t))))));return this.ma=e,e}enqueueAfterDelay(t,e,n){this.Pa(),this.Aa.indexOf(t)>-1&&(e=0);const r=ro.createAndSchedule(this,t,e,n,(t=>this.Va(t)));return this.pa.push(r),r}Pa(){this.Ta&&v()}verifyOperationInProgress(){}async Sa(){let t;do{t=this.ma,await t}while(t!==this.ma)}Da(t){for(const e of this.pa)if(e.timerId===t)return!0;return!1}Ca(t){return this.Sa().then((()=>{this.pa.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.pa)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Sa()}))}Na(t){this.Aa.push(t)}Va(t){const e=this.pa.indexOf(t);this.pa.splice(e,1)}}function Ga(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const n=t;for(const r of["next","error","complete"])if(r in n&&"function"==typeof n[r])return!0;return!1}(t)}class za{constructor(){this._progressObserver={},this._taskCompletionResolver=new k,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const Qa=-1;class Wa extends Ma{constructor(t,e,n){super(t,e,n),this.type="firestore",this._queue=new ja,this._persistenceKey="name"in t?t.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||Ya(this),this._firestoreClient.terminate()}}function Ha(t){return t._firestoreClient||Ya(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function Ya(t){var e;const n=t._freezeSettings(),r=function(t,e,n,r){return new ba(t,e,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,r.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,n);t._firestoreClient=new ha(t._authCredentials,t._appCheckCredentials,t._queue,r)}function Ja(t,e){oc(t=xa(t,Wa));const n=Ha(t),r=t._freezeSettings(),s=new sa;return Za(n,s,new na(s,r.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function Xa(t){oc(t=xa(t,Wa));const e=Ha(t),n=t._freezeSettings(),r=new sa;return Za(e,r,new ra(r,n.cacheSizeBytes))}function Za(t,e,n){const r=new k;return t.asyncQueue.enqueue((async()=>{try{await la(t,n),await da(t,e),r.resolve()}catch(t){if(!function(t){return"FirebaseError"===t.name?t.code===b.FAILED_PRECONDITION||t.code===b.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||(22===t.code||20===t.code||11===t.code)}(t))throw t;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),r.reject(t)}})).then((()=>r.promise))}function tc(t){if(t._initialized&&!t._terminated)throw new S(b.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new k;return t._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(t){if(!Tr.bt())return Promise.resolve();const e=t+"main";await Tr.delete(e)}(Rs(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function ec(t){return function(t){const e=new k;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e){const n=E(t);Vi(n.remoteStore)||g("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(t){const e=E(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(t=>e.An.getHighestUnacknowledgedBatchId(t)))}(n.localStore);if(-1===t)return void e.resolve();const r=n.jo.get(t)||[];r.push(e),n.jo.set(t,r)}catch(t){const n=so(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await wa(t),e))),e.promise}(Ha(t=xa(t,Wa)))}function nc(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await ga(t),n=await ya(t);return e.setNetworkEnabled(!0),function(t){const e=E(t);return e.Gr.delete(0),Ci(e)}(n)}))}(Ha(t=xa(t,Wa)))}function rc(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await ga(t),n=await ya(t);return e.setNetworkEnabled(!1),async function(t){const e=E(t);e.Gr.add(0),await xi(e),e.Jr.set("Offline")}(n)}))}(Ha(t=xa(t,Wa)))}function sc(t,e){const n=Ha(t=xa(t,Wa)),r=new za;return Ea(n,t._databaseId,e,r),r}function ic(t,e){return function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){const n=E(t);return n.persistence.runTransaction("Get named query","readonly",(t=>n.Ye.getNamedQuery(t,e)))}(await pa(t),e)))}(Ha(t=xa(t,Wa)),e).then((e=>e?new Pa(t,null,e.query):null))}function oc(t){if(t._initialized||t._terminated)throw new S(b.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class ac{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new S(b.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new W(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}class cc{constructor(t){this._byteString=t}static fromBase64String(t){try{return new cc(J.fromBase64String(t))}catch(t){throw new S(b.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new cc(J.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class uc{constructor(t){this._methodName=t}}class hc{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new S(b.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new S(b.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return P(this._lat,t._lat)||P(this._long,t._long)}}const lc=/^__.*__$/;class dc{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new Fe(t,this.data,this.fieldMask,e,this.fieldTransforms):new Me(t,this.data,e,this.fieldTransforms)}}class fc{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Fe(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function mc(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw v()}}class gc{constructor(t,e,n,r,s,i){this.settings=t,this.databaseId=e,this.k=n,this.ignoreUndefinedProperties=r,void 0===s&&this.ka(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get xa(){return this.settings.xa}$a(t){return new gc(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.k,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Fa(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.$a({path:n,Oa:!1});return r.Ma(t),r}La(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.$a({path:n,Oa:!1});return r.ka(),r}Ba(t){return this.$a({path:void 0,Oa:!0})}Ua(t){return Fc(t,this.settings.methodName,this.settings.qa||!1,this.path,this.settings.Ka)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}ka(){if(this.path)for(let t=0;t<this.path.length;t++)this.Ma(this.path.get(t))}Ma(t){if(0===t.length)throw this.Ua("Document fields must not be empty");if(mc(this.xa)&&lc.test(t))throw this.Ua('Document fields cannot begin and end with "__"')}}class pc{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.k=n||Ei(t)}ja(t,e,n,r=!1){return new gc({xa:t,methodName:e,Ka:n,path:W.emptyPath(),Oa:!1,qa:r},this.databaseId,this.k,this.ignoreUndefinedProperties)}}function yc(t){const e=t._freezeSettings(),n=Ei(t._databaseId);return new pc(t._databaseId,!!e.ignoreUndefinedProperties,n)}function wc(t,e,n,r,s,i={}){const o=t.ja(i.merge||i.mergeFields?2:0,e,n,s);xc("Data must be an object, but it was:",o,r);const a=Dc(r,o);let c,u;if(i.merge)c=new H(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const r of i.mergeFields){const s=Rc(e,r,n);if(!o.contains(s))throw new S(b.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Oc(t,s)||t.push(s)}c=new H(t),u=o.fieldTransforms.filter((t=>c.covers(t.field)))}else c=null,u=o.fieldTransforms;return new dc(new bt(a),c,u)}class vc extends uc{_toFieldTransform(t){if(2!==t.xa)throw 1===t.xa?t.Ua(`${this._methodName}() can only appear at the top level of your update data`):t.Ua(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof vc}}function Ic(t,e,n){return new gc({xa:3,Ka:e.settings.Ka,methodName:t._methodName,Oa:n},e.databaseId,e.k,e.ignoreUndefinedProperties)}class Tc extends uc{_toFieldTransform(t){return new Se(t.path,new pe)}isEqual(t){return t instanceof Tc}}class Ec extends uc{constructor(t,e){super(t),this.Qa=e}_toFieldTransform(t){const e=Ic(this,t,!0),n=this.Qa.map((t=>Nc(t,e))),r=new ye(n);return new Se(t.path,r)}isEqual(t){return this===t}}class bc extends uc{constructor(t,e){super(t),this.Qa=e}_toFieldTransform(t){const e=Ic(this,t,!0),n=this.Qa.map((t=>Nc(t,e))),r=new ve(n);return new Se(t.path,r)}isEqual(t){return this===t}}class Sc extends uc{constructor(t,e){super(t),this.Wa=e}_toFieldTransform(t){const e=new Te(t.k,le(t.k,this.Wa));return new Se(t.path,e)}isEqual(t){return this===t}}function kc(t,e,n,r){const s=t.ja(1,e,n);xc("Data must be an object, but it was:",s,r);const i=[],a=bt.empty();$(r,((t,r)=>{const c=Mc(e,t,n);r=(0,o.m9)(r);const u=s.La(c);if(r instanceof vc)i.push(c);else{const t=Nc(r,u);null!=t&&(i.push(c),a.set(c,t))}}));const c=new H(i);return new fc(a,c,s.fieldTransforms)}function _c(t,e,n,r,s,i){const a=t.ja(1,e,n),c=[Rc(e,r,n)],u=[s];if(i.length%2!=0)throw new S(b.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let o=0;o<i.length;o+=2)c.push(Rc(e,i[o])),u.push(i[o+1]);const h=[],l=bt.empty();for(let f=c.length-1;f>=0;--f)if(!Oc(h,c[f])){const t=c[f];let e=u[f];e=(0,o.m9)(e);const n=a.La(t);if(e instanceof vc)h.push(t);else{const r=Nc(e,n);null!=r&&(h.push(t),l.set(t,r))}}const d=new H(h);return new fc(l,d,a.fieldTransforms)}function Ac(t,e,n,r=!1){return Nc(n,t.ja(r?4:3,e))}function Nc(t,e){if(Cc(t=(0,o.m9)(t)))return xc("Unsupported field value:",e,t),Dc(t,e);if(t instanceof uc)return function(t,e){if(!mc(e.xa))throw e.Ua(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.Ua(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.Oa&&4!==e.xa)throw e.Ua("Nested arrays are not supported");return function(t,e){const n=[];let r=0;for(const s of t){let t=Nc(s,e.Ba(r));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),r++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=(0,o.m9)(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return le(e.k,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=U.fromDate(t);return{timestampValue:In(e.k,n)}}if(t instanceof U){const n=new U(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:In(e.k,n)}}if(t instanceof hc)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof cc)return{bytesValue:Tn(e.k,t._byteString)};if(t instanceof Oa){const n=e.databaseId,r=t.firestore._databaseId;if(!r.isEqual(n))throw e.Ua(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:Sn(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.Ua(`Unsupported field value: ${Ca(t)}`)}(t,e)}function Dc(t,e){const n={};return j(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):$(t,((t,r)=>{const s=Nc(r,e.Fa(t));null!=s&&(n[t]=s)})),{mapValue:{fields:n}}}function Cc(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof U||t instanceof hc||t instanceof cc||t instanceof Oa||t instanceof uc)}function xc(t,e,n){if(!Cc(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const r=Ca(n);throw"an object"===r?e.Ua(t+" a custom object"):e.Ua(t+" "+r)}}function Rc(t,e,n){if((e=(0,o.m9)(e))instanceof ac)return e._internalPath;if("string"==typeof e)return Mc(t,e);throw Fc("Field path arguments must be of type string or FieldPath.",t,!1,void 0,n)}const Lc=new RegExp("[~\\*/\\[\\]]");function Mc(t,e,n){if(e.search(Lc)>=0)throw Fc(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new ac(...e.split("."))._internalPath}catch(r){throw Fc(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function Fc(t,e,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(i||o)&&(c+=" (found",i&&(c+=` in field ${r}`),o&&(c+=` in document ${s}`),c+=")"),new S(b.INVALID_ARGUMENT,a+t+c)}function Oc(t,e){return t.some((t=>t.isEqual(e)))}class Pc{constructor(t,e,n,r,s){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Oa(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new Vc(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(qc("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class Vc extends Pc{data(){return super.data()}}function qc(t,e){return"string"==typeof e?Mc(t,e):e instanceof ac?e._internalPath:e._delegate._internalPath}class Uc{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Bc extends Pc{constructor(t,e,n,r,s,i){super(t,e,n,r,i),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new Kc(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field(qc("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class Kc extends Bc{data(t={}){return super.data(t)}}class $c{constructor(t,e,n,r){this._firestore=t,this._userDataWriter=e,this._snapshot=r,this.metadata=new Uc(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new Kc(this._firestore,this._userDataWriter,n.key,n,new Uc(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new S(b.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>({type:"added",doc:new Kc(t._firestore,t._userDataWriter,n.doc.key,n.doc,new Uc(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter),oldIndex:-1,newIndex:e++})))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const r=new Kc(t._firestore,t._userDataWriter,e.doc.key,e.doc,new Uc(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let s=-1,i=-1;return 0!==e.type&&(s=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),i=n.indexOf(e.doc.key)),{type:jc(e.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function jc(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return v()}}function Gc(t,e){return t instanceof Bc&&e instanceof Bc?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof $c&&e instanceof $c&&t._firestore===e._firestore&&$a(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function zc(t){if(Yt(t)&&0===t.explicitOrderBy.length)throw new S(b.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Qc{}function Wc(t,...e){for(const n of e)t=n._apply(t);return t}class Hc extends Qc{constructor(t,e,n){super(),this.Ga=t,this.za=e,this.Ha=n,this.type="where"}_apply(t){const e=yc(t.firestore),n=function(t,e,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new S(b.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on FieldPath.documentId().`);if("in"===i||"not-in"===i){hu(o,i);const e=[];for(const n of o)e.push(uu(r,t,n));a={arrayValue:{values:e}}}else a=uu(r,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||hu(o,i),a=Ac(n,"where",o,"in"===i||"not-in"===i);const c=xt.create(s,i,a);return function(t,e){if(e.V()){const n=Xt(t);if(null!==n&&!n.isEqual(e.field))throw new S(b.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${e.field.toString()}'`);const r=Jt(t);null!==r&&lu(t,e.field,r)}const n=function(t,e){for(const n of t.filters)if(e.indexOf(n.op)>=0)return n.op;return null}(t,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==n)throw n===e.op?new S(b.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new S(b.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}(t,c),c}(t._query,0,e,t.firestore._databaseId,this.Ga,this.za,this.Ha);return new Pa(t.firestore,t.converter,function(t,e){const n=t.filters.concat([e]);return new zt(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}(t._query,n))}}function Yc(t,e,n){const r=e,s=qc("where",t);return new Hc(s,r,n)}class Jc extends Qc{constructor(t,e){super(),this.Ga=t,this.Ja=e,this.type="orderBy"}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new S(b.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new S(b.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const r=new Kt(e,n);return function(t,e){if(null===Jt(t)){const n=Xt(t);null!==n&&lu(t,n,e.field)}}(t,r),r}(t._query,this.Ga,this.Ja);return new Pa(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new zt(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function Xc(t,e="asc"){const n=e,r=qc("orderBy",t);return new Jc(r,n)}class Zc extends Qc{constructor(t,e,n){super(),this.type=t,this.Ya=e,this.Xa=n}_apply(t){return new Pa(t.firestore,t.converter,ne(t._query,this.Ya,this.Xa))}}function tu(t){return Ra("limit",t),new Zc("limit",t,"F")}function eu(t){return Ra("limitToLast",t),new Zc("limitToLast",t,"L")}class nu extends Qc{constructor(t,e,n){super(),this.type=t,this.Za=e,this.tc=n}_apply(t){const e=cu(t,this.type,this.Za,this.tc);return new Pa(t.firestore,t.converter,function(t,e){return new zt(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function ru(...t){return new nu("startAt",t,!0)}function su(...t){return new nu("startAfter",t,!1)}class iu extends Qc{constructor(t,e,n){super(),this.type=t,this.Za=e,this.tc=n}_apply(t){const e=cu(t,this.type,this.Za,this.tc);return new Pa(t.firestore,t.converter,function(t,e){return new zt(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function ou(...t){return new iu("endBefore",t,!0)}function au(...t){return new iu("endAt",t,!1)}function cu(t,e,n,r){if(n[0]=(0,o.m9)(n[0]),n[0]instanceof Pc)return function(t,e,n,r,s){if(!r)throw new S(b.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const o of te(t))if(o.field.isKeyField())i.push(pt(e,r.key));else{const t=r.data.field(o.field);if(nt(t))throw new S(b.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+o.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=o.field.canonicalString();throw new S(b.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new Ut(i,s)}(t._query,t.firestore._databaseId,e,n[0]._document,r);{const s=yc(t.firestore);return function(t,e,n,r,s,i){const o=t.explicitOrderBy;if(s.length>o.length)throw new S(b.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let c=0;c<s.length;c++){const i=s[c];if(o[c].field.isKeyField()){if("string"!=typeof i)throw new S(b.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof i}`);if(!Zt(t)&&-1!==i.indexOf("/"))throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to ${r}() must be a plain document ID, but '${i}' contains a slash.`);const n=t.path.child(z.fromString(i));if(!ct.isDocumentKey(n))throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new ct(n);a.push(pt(e,s))}else{const t=Ac(n,r,i);a.push(t)}}return new Ut(a,i)}(t._query,t.firestore._databaseId,s,e,n,r)}}function uu(t,e,n){if("string"==typeof(n=(0,o.m9)(n))){if(""===n)throw new S(b.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!Zt(e)&&-1!==n.indexOf("/"))throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=e.path.child(z.fromString(n));if(!ct.isDocumentKey(r))throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return pt(t,new ct(r))}if(n instanceof Oa)return pt(t,n._key);throw new S(b.INVALID_ARGUMENT,`Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: ${Ca(n)}.`)}function hu(t,e){if(!Array.isArray(t)||0===t.length)throw new S(b.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`);if(t.length>10)throw new S(b.INVALID_ARGUMENT,`Invalid Query. '${e.toString()}' filters support a maximum of 10 elements in the value array.`)}function lu(t,e,n){if(!n.isEqual(e))throw new S(b.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${e.toString()}' and so you must also use '${e.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class du{convertValue(t,e="none"){switch(ut(t)){case 0:return null;case 1:return t.booleanValue;case 2:return tt(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(et(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw v()}}convertObject(t,e){const n={};return $(t.fields,((t,r)=>{n[t]=this.convertValue(r,e)})),n}convertGeoPoint(t){return new hc(tt(t.latitude),tt(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=rt(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(st(t));default:return null}}convertTimestamp(t){const e=Z(t);return new U(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=z.fromString(t);I(Hn(n));const r=new Sa(n.get(1),n.get(3)),s=new ct(n.popFirst(5));return r.isEqual(e)||p(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}}function fu(t,e,n){let r;return r=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,r}class mu extends du{constructor(t){super(),this.firestore=t}convertBytes(t){return new cc(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Oa(this.firestore,null,e)}}class gu{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=yc(t)}set(t,e,n){this._verifyNotCommitted();const r=pu(t,this._firestore),s=fu(r.converter,e,n),i=wc(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,_e.none())),this}update(t,e,n,...r){this._verifyNotCommitted();const s=pu(t,this._firestore);let i;return i="string"==typeof(e=(0,o.m9)(e))||e instanceof ac?_c(this._dataReader,"WriteBatch.update",s._key,e,n,r):kc(this._dataReader,"WriteBatch.update",s._key,e),this._mutations.push(i.toMutation(s._key,_e.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=pu(t,this._firestore);return this._mutations=this._mutations.concat(new qe(e._key,_e.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new S(b.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function pu(t,e){if((t=(0,o.m9)(t)).firestore!==e)throw new S(b.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}function yu(t){t=xa(t,Oa);const e=xa(t.firestore,Wa);return Ia(Ha(e),t._key).then((n=>xu(e,t,n)))}class wu extends du{constructor(t){super(),this.firestore=t}convertBytes(t){return new cc(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Oa(this.firestore,null,e)}}function vu(t){t=xa(t,Oa);const e=xa(t.firestore,Wa),n=Ha(e),r=new wu(e);return function(t,e){const n=new k;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await function(t,e){const n=E(t);return n.persistence.runTransaction("read document","readonly",(t=>n.Wn.Rn(t,e)))}(t,e);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new S(b.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const r=so(t,`Failed to get document '${e} from cache`);n.reject(r)}}(await pa(t),e,n))),n.promise}(n,t._key).then((n=>new Bc(e,r,t._key,n,new Uc(null!==n&&n.hasLocalMutations,!0),t.converter)))}function Iu(t){t=xa(t,Oa);const e=xa(t.firestore,Wa);return Ia(Ha(e),t._key,{source:"server"}).then((n=>xu(e,t,n)))}function Tu(t){t=xa(t,Pa);const e=xa(t.firestore,Wa),n=Ha(e),r=new wu(e);return zc(t._query),Ta(n,t._query).then((n=>new $c(e,r,t,n)))}function Eu(t){t=xa(t,Pa);const e=xa(t.firestore,Wa),n=Ha(e),r=new wu(e);return function(t,e){const n=new k;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await Gs(t,e,!0),s=new bo(e,r.zn),i=s.bo(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(t){const r=so(t,`Failed to execute query '${e} against cache`);n.reject(r)}}(await pa(t),e,n))),n.promise}(n,t._query).then((n=>new $c(e,r,t,n)))}function bu(t){t=xa(t,Pa);const e=xa(t.firestore,Wa),n=Ha(e),r=new wu(e);return Ta(n,t._query,{source:"server"}).then((n=>new $c(e,r,t,n)))}function Su(t,e,n){t=xa(t,Oa);const r=xa(t.firestore,Wa),s=fu(t.converter,e,n);return Cu(r,[wc(yc(r),"setDoc",t._key,s,null!==t.converter,n).toMutation(t._key,_e.none())])}function ku(t,e,n,...r){t=xa(t,Oa);const s=xa(t.firestore,Wa),i=yc(s);let a;return a="string"==typeof(e=(0,o.m9)(e))||e instanceof ac?_c(i,"updateDoc",t._key,e,n,r):kc(i,"updateDoc",t._key,e),Cu(s,[a.toMutation(t._key,_e.exists(!0))])}function _u(t){return Cu(xa(t.firestore,Wa),[new qe(t._key,_e.none())])}function Au(t,e){const n=xa(t.firestore,Wa),r=Ba(t),s=fu(t.converter,e);return Cu(n,[wc(yc(t.firestore),"addDoc",r._key,s,null!==t.converter,{}).toMutation(r._key,_e.exists(!1))]).then((()=>r))}function Nu(t,...e){var n,r,s;t=(0,o.m9)(t);let i={includeMetadataChanges:!1},a=0;"object"!=typeof e[a]||Ga(e[a])||(i=e[a],a++);const c={includeMetadataChanges:i.includeMetadataChanges};if(Ga(e[a])){const t=e[a];e[a]=null===(n=t.next)||void 0===n?void 0:n.bind(t),e[a+1]=null===(r=t.error)||void 0===r?void 0:r.bind(t),e[a+2]=null===(s=t.complete)||void 0===s?void 0:s.bind(t)}let u,h,l;if(t instanceof Oa)h=xa(t.firestore,Wa),l=Wt(t._key.path),u={next:n=>{e[a]&&e[a](xu(h,t,n))},error:e[a+1],complete:e[a+2]};else{const n=xa(t,Pa);h=xa(n.firestore,Wa),l=n._query;const r=new wu(h);u={next:t=>{e[a]&&e[a](new $c(h,r,n,t))},error:e[a+1],complete:e[a+2]},zc(t._query)}return function(t,e,n,r){const s=new oa(r),i=new po(e,s,n);return t.asyncQueue.enqueueAndForget((async()=>ho(await va(t),i))),()=>{s.na(),t.asyncQueue.enqueueAndForget((async()=>lo(await va(t),i)))}}(Ha(h),l,c,u)}function Du(t,e){return function(t,e){const n=new oa(e);return t.asyncQueue.enqueueAndForget((async()=>function(t,e){E(t).io.add(e),e.next()}(await va(t),n))),()=>{n.na(),t.asyncQueue.enqueueAndForget((async()=>function(t,e){E(t).io.delete(e)}(await va(t),n)))}}(Ha(t=xa(t,Wa)),Ga(e)?e:{next:e})}function Cu(t,e){return function(t,e){const n=new k;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const r=ta(t);try{const t=await function(t,e){const n=E(t),r=U.now(),s=e.reduce(((t,e)=>t.add(e.key)),sn());let i;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>n.Wn.vn(t,s).next((s=>{i=s;const o=[];for(const t of e){const e=xe(t,i.get(t.key));null!=e&&o.push(new Fe(t.key,e,St(e.value.mapValue),_e.exists(!0)))}return n.An.addMutationBatch(t,r,o,e)})))).then((t=>(t.applyToLocalDocumentSet(i),{batchId:t.batchId,changes:i})))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let r=t.Ko[t.currentUser.toKey()];r||(r=new ze(P)),r=r.insert(e,n),t.Ko[t.currentUser.toKey()]=r}(r,t.batchId,n),await Ko(r,t.changes),await Gi(r.remoteStore)}catch(t){const e=so(t,"Failed to persist write");n.reject(e)}}(await wa(t),e,n))),n.promise}(Ha(t),e)}function xu(t,e,n){const r=n.docs.get(e._key),s=new wu(t);return new Bc(t,s,e._key,r,new Uc(n.hasPendingWrites,n.fromCache),e.converter)}class Ru extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=yc(t)}get(t){const e=pu(t,this._firestore),n=new mu(this._firestore);return this._transaction.lookup([e._key]).then((t=>{if(!t||1!==t.length)return v();const r=t[0];if(r.isFoundDocument())return new Pc(this._firestore,n,r.key,r,e.converter);if(r.isNoDocument())return new Pc(this._firestore,n,e._key,null,e.converter);throw v()}))}set(t,e,n){const r=pu(t,this._firestore),s=fu(r.converter,e,n),i=wc(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(t,e,n,...r){const s=pu(t,this._firestore);let i;return i="string"==typeof(e=(0,o.m9)(e))||e instanceof ac?_c(this._dataReader,"Transaction.update",s._key,e,n,r):kc(this._dataReader,"Transaction.update",s._key,e),this._transaction.update(s._key,i),this}delete(t){const e=pu(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=pu(t,this._firestore),n=new wu(this._firestore);return super.get(t).then((t=>new Bc(this._firestore,n,e._key,t._document,new Uc(!1,!1),e.converter)))}}function Lu(t,e){return function(t,e){const n=new k;return t.asyncQueue.enqueueAndForget((async()=>{const r=await function(t){return ma(t).then((t=>t.datastore))}(t);new ua(t.asyncQueue,r,e,n).run()})),n.promise}(Ha(t=xa(t,Wa)),(n=>e(new Ru(t,n))))}function Mu(){return new vc("deleteField")}function Fu(){return new Tc("serverTimestamp")}function Ou(...t){return new Ec("arrayUnion",t)}function Pu(...t){return new bc("arrayRemove",t)}function Vu(t){return new Sc("increment",t)}!function(t,e=!0){!function(t){l=t}(r.SDK_VERSION),(0,r._registerComponent)(new s.wA("firestore",((t,{options:n})=>{const r=t.getProvider("app").getImmediate(),s=new Wa(r,new D(t.getProvider("auth-internal")),new L(t.getProvider("app-check-internal")));return n=Object.assign({useFetchStreams:e},n),s._setSettings(n),s}),"PUBLIC")),(0,r.registerVersion)(u,"3.4.1",t),(0,r.registerVersion)(u,"3.4.1","esm2017")}()}}]);